<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="searchSqlMap">

	<select id="getDocSearchList_new" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
		SELECT TOP 1000 ppi.prj_nm,a.*,(select code.set_code from p_prj_code_settings code where code.prj_id = a.prj_id and  code.set_code_type = 'REVISION NUMBER' and code.set_code_id = a.rev_code_id) as rev_no
			,f.folder_nm, f.folder_path, pu.user_kor_nm as modifier
		FROM p_prj_document_index a LEFT OUTER JOIN p_prj_folder_info f on (a.prj_id = f.prj_id and a.folder_id = f.folder_id)
			left outer join p_prj_info ppi on (a.prj_id = ppi.prj_id)
			left outer join p_users pu on (a.mod_id = pu.user_id)
			,( select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			  where del_yn!='Y' group by prj_id,doc_id)b
		WHERE
		 <if test='!version.equals("all")'>
			a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			and
		</if>
		<choose>
			<when test="!allPrjchk">
	     	  A.prj_id	= #{prj_id} and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and 
	    	</when>
		</choose> 
     		( A.doc_no		like #{keyword}
     		  or
     		  A.title		like #{keyword}
     		  or
     		  A.reg_id		like #{keyword}
     		  or
     		  A.mod_id		like #{keyword})
     		  <if test="periodChk">
     		  and
     		  ( A.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	A.mod_date between #{searchFrom} AND #{searchTo}
     		  )
     		  </if>
			  <if test="folder_path != null">
     		  and F.folder_path like #{folder_path}
     		  </if>
     		  and a.del_yn != 'Y'
	</select>


	<select id="getDocSearchList_new2" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
		SELECT TOP ${max_Display} ppi.prj_nm,a.*,(select code.set_code from p_prj_code_settings code where code.prj_id = a.prj_id and  code.set_code_type = 'REVISION NUMBER' and code.set_code_id = a.rev_code_id) as rev_no
			,f.folder_nm, f.folder_path, dbo.fn_getFolderNm(a.prj_id,a.folder_id) as folder_str, CONCAT(pu.user_kor_nm,' ',pci.code_nm) as modifier
		FROM p_prj_document_index a LEFT OUTER JOIN p_prj_folder_info f on (a.prj_id = f.prj_id and a.folder_id = f.folder_id)
			left outer join p_prj_info ppi on (a.prj_id = ppi.prj_id and ppi.prj_hidden_yn = 'N')
			left outer join p_users pu on (a.mod_id = pu.user_id AND pu.user_st != 'D')
			left outer join p_code_info pci on(pu.job_tit_cd = pci.code and pci.code_gubun ='JOB')
			,( select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			  where del_yn!='Y' group by prj_id,doc_id)b
		WHERE
		 <if test='!version.equals("all")'>
			a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			and
		</if>
		<choose>
			<when test="!allPrjchk">
	     	  A.prj_id	= #{prj_id} and ppi.prj_hidden_yn != 'Y' and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and ppi.prj_hidden_yn != 'Y' and
	    	</when>
		</choose> 
     		( A.doc_no		like #{keyword}
     		  or
     		  A.title		like #{keyword}
     		  or
     		  A.reg_id		like #{keyword}
     		  or
     		  A.mod_id		like #{keyword})
     		  <if test="periodChk">
     		  and
     		  ( A.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	A.mod_date between #{searchFrom} AND #{searchTo}
     		  )
     		  </if>
		<if test="folder_path != null">
     		  and (F.folder_path like #{folder_path})
     	 </if>
     		  and (a.del_yn != 'Y')
     	 <if test='basic_input_doc_no != null and !basic_input_doc_no.equals("")'>
     		  and
     		  ( A.doc_no like #{basic_input_doc_no} )
     	 </if>
     	 <if test='basic_input_title != null and !basic_input_title.equals("")'>
     		  and
     		  ( A.title like #{basic_input_title} )
     	 </if>
     	 <if test='!detail_sel_doc_type.equals("all")'>
     		  and
     		  ( A.doc_type = ${detail_sel_doc_type} )
     	 </if>
     	 <if test='modifier != null and !modifier.equals("")'>
     		  and
     		  (A.mod_id = #{modifier} or  pu.user_kor_nm = #{modifier} )     		  
     	 </if>
     	 <if test='mod_periodChk'>
     		  and
     		  (A.mod_date between #{mod_searchFrom} and #{mod_searchTo} )     		  
     	 </if>
     		  
	</select>



	<select id="getDocSearchList" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
	
     	SELECT P.prj_id, prj_nm, D.*, F.folder_path, F.folder_nm,F.folder_id,D.doc_id,D.rev_id
		FROM (p_prj_info P INNER JOIN p_prj_document_index D ON P.prj_id = D.prj_id)
		INNER JOIN p_prj_folder_info F ON (P.prj_id = F.prj_id and D.folder_id = F.folder_id)
		WHERE 
		<choose>
			<when test="!allPrjchk">
	     	  D.prj_id		= #{prj_id} and 
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and
	    	</when>
		</choose> 
     		( D.title		like #{keyword}
     		  or
     		  D.reg_id		like #{keyword}
     		  or
     		  D.mod_id		like #{keyword}
     		  or
     		  F.folder_nm	like #{keyword} )
     		  <if test="periodChk">
     		  and
     		  ( D.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	D.mod_date between #{searchFrom} AND #{searchTo}
     		  )
     		  </if>
     		  
			  <if test="folder_path != null">
     		  and F.folder_path like #{folder_path}
     		  </if>
   
    </select>
    
    <select id="getTRSearchList" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
	
     	SELECT TOP ${max_Display} 'TR'as trType,P.prj_id, prj_nm, T.*, D.discip_display , CONCAT(pu.user_kor_nm,' ',pci.code_nm)  as modifier 
		FROM (p_prj_info P INNER JOIN p_prj_tr_info T ON P.prj_id = T.prj_id and P.prj_hidden_yn = 'N')
			left outer JOIN p_prj_discipline_info D ON p.prj_id = D.prj_id and T.discipline_code_id = D.discip_code_id
			left outer join p_users pu on (T.tr_modifier_id = pu.user_id AND pu.user_st != 'D')
			left outer join p_code_info pci on(pu.job_tit_cd = pci.code and pci.code_gubun ='JOB')
		WHERE 
		<choose>
			<when test="!allPrjchk">
	     	  P.prj_id		= #{prj_id} and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and
	    	</when>
		</choose> 
			(   T.tr_no			like #{keyword}
				or
				T.itr_no		like #{keyword}
				or
				T.tr_subject	like #{keyword} 
				or
		  		D.discip_code like #{keyword}
		  		or
		  		D.discip_display like #{keyword} ) 
		<if test="periodChk">
     		  and
     		  ( T.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	T.mod_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	CONCAT(T.send_date,'000000') BETWEEN #{searchFrom} AND #{searchTo}
     		  )
     	</if>
     	<if test='mod_periodChk'>
     		  and
     		  (T.mod_date between #{mod_searchFrom} and #{mod_searchTo} )     		  
     	 </if>
     	 <if test='modifier != null and !modifier.equals("")'>
     		  and
     		  (T.tr_modifier_id = #{modifier} or  pu.user_kor_nm = #{modifier} )     		  
     	 </if>
				
    </select>
    
    <select id="getVTRSearchList" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
	
     	SELECT TOP ${max_Display} 'VTR'as trType, P.prj_id, prj_nm, T.*, D.discip_display , CONCAT(pu.user_kor_nm,' ',pci.code_nm)  as modifier 
		FROM (p_prj_info P INNER JOIN p_prj_vtr_info T ON P.prj_id = T.prj_id and P.prj_hidden_yn = 'N')
			LEFT OUTER JOIN p_prj_discipline_info D ON P.prj_id = D.prj_id and T.discipline_code_id = D.discip_code_id
			LEFT OUTER join p_users pu on (T.tr_modifier_id = pu.user_id AND pu.user_st != 'D')
			LEFT OUTER join p_code_info pci on(pu.job_tit_cd = pci.code and pci.code_gubun ='JOB')
		WHERE 
		<choose>
			<when test="!allPrjchk">
	     	  P.prj_id		= #{prj_id} and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and
	    	</when>
		</choose> 
			(   T.tr_no			like #{keyword}
				or
				T.itr_no		like #{keyword}
				or
				T.tr_subject	like #{keyword}
				or
		  		D.discip_code like #{keyword}
		  		or
		  		D.discip_display like #{keyword} ) 
		<if test="periodChk">
     		  and
     		  ( T.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	T.mod_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	CONCAT(T.send_date,'000000') BETWEEN #{searchFrom} AND #{searchTo}
     		  )
     	</if>
     	<if test='mod_periodChk'>
     		  and
     		  (T.mod_date between #{mod_searchFrom} and #{mod_searchTo} )     		  
     	 </if>
     	  <if test='modifier != null and !modifier.equals("")'>
     		  and
     		  (T.tr_modifier_id = #{modifier} or  pu.user_kor_nm = #{modifier} )     		  
     	 </if>
				
    </select>
    
    <select id="getSTRSearchList" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
	
     	SELECT TOP ${max_Display} 'STR'as trType, P.prj_id, prj_nm, T.*, D.discip_display , CONCAT(pu.user_kor_nm,' ',pci.code_nm)  as modifier
		FROM (p_prj_info P INNER JOIN p_prj_str_info T ON P.prj_id = T.prj_id and P.prj_hidden_yn = 'N')
			JOIN p_prj_discipline_info D ON P.prj_id = D.prj_id and T.discipline_code_id = D.discip_code_id
			join p_users pu on (T.tr_modifier_id = pu.user_id AND pu.user_st != 'D')
			join p_code_info pci on(pu.job_tit_cd = pci.code and pci.code_gubun ='JOB')
		WHERE 
		<choose>
			<when test="!allPrjchk">
	     	  P.prj_id		= #{prj_id} and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and
	    	</when>
		</choose> 
			(   T.tr_no			like #{keyword}
				or
				T.itr_no		like #{keyword}
				or
				T.tr_subject	like #{keyword}
				or
		  		D.discip_code like #{keyword}
		  		or
		  		D.discip_display like #{keyword} ) 
		 <if test="periodChk">
     		  and
     		  ( T.reg_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	T.mod_date between #{searchFrom} AND #{searchTo}
     		  	or
     		  	CONCAT(T.send_date,'000000') BETWEEN #{searchFrom} AND #{searchTo}
     		  )
     	</if>
     	<if test='mod_periodChk'>
     		  and
     		  (T.mod_date between #{mod_searchFrom} and #{mod_searchTo} )     		  
     	 </if>
     	 <if test='modifier != null and !modifier.equals("")'>
     		  and
     		  (T.tr_modifier_id = #{modifier} or  pu.user_kor_nm = #{modifier} )     		  
     	 </if>	
     	 	
    </select>
    
    <select id="getDRNSearchList" resultType="GlobalSearchVO" parameterType="GlobalSearchVO">
	SELECT DISTINCT TOP ${max_Display} P.prj_id , P.prj_nm, D.* , CONCAT(pu.user_kor_nm,' ',pci.code_nm) as modifier , a.doc_no,a.title , DIS.discip_code_id  ,DIS.discip_code , DIS.discip_display
	FROM (p_prj_info P RIGHT JOIN p_prj_drn_info D ON P.prj_id = D.prj_id)
		left outer JOIN p_users pu ON (D.mod_id = pu.user_id and pu.user_st != 'D')
		left outer join p_code_info pci on(pu.job_tit_cd = pci.code and pci.code_gubun ='JOB') 
		left outer JOIN p_prj_drn_attch_file DF ON D.prj_id = DF.prj_id and D.drn_id = DF.drn_id
		left outer JOIN p_prj_document_index a on DF.prj_id = a.prj_id and DF.doc_id = a.doc_id  and DF.rev_id = a.rev_id
		left outer JOIN p_prj_folder_info ppfi on a.prj_id = ppfi.prj_id and a.folder_id = ppfi.folder_id
		left outer JOIN (p_prj_discipline_info DIS LEFT JOIN p_prj_discipline_folder_info DISF ON DIS.prj_id = DISF.prj_id and DIS.discip_code_id = DISF.discip_code_id) ON DF.folder_id = DISF.discip_folder_id
	WHERE 
		P.prj_hidden_yn = 'N' and
		<choose>
			<when test="!allPrjchk">
	     	  P.prj_id		= #{prj_id} and
	     	</when>
			<when test="allPrjchk">
			( 1 = 1 )  and
	    	</when>
		</choose> 
		( D.drn_no		like #{keyword}
		  or
		  D.drn_title	like #{keyword}
		  or
		  D.doc_title	like #{keyword}
		  or
		  DIS.discip_code like #{keyword}
		  or
		  DIS.discip_display like #{keyword} )
		  and D.drn_approval_status != 'T'
		  <if test="folder_path != null">
     		  and 
     		  (ppfi.folder_path like #{folder_path} )
     	 </if>
		  <if test='basic_input_doc_no != null and !basic_input_doc_no.equals("")'>
     		  and
     		  ( a.doc_no like #{basic_input_doc_no} )
     	 </if>
     	 <if test='basic_input_title != null and !basic_input_title.equals("")'>
     		  and
     		  ( 
     		    A.title like #{basic_input_title}
     		    or
     		    D.drn_title	like #{basic_input_title} 
     		  )
     	 </if>
     	 <if test='!detail_sel_doc_type.equals("all")'>
     		  and
     		  (a.doc_type = ${detail_sel_doc_type} )
     	 </if>
     	 <if test='modifier != null and !modifier.equals("")'>
     		  and
     		  (D.mod_id = #{modifier} or  pu.user_kor_nm = #{modifier} )     		  
     	 </if>
     	 <if test='mod_periodChk'>
     		  and
     		  (D.mod_date between #{mod_searchFrom} and #{mod_searchTo} )     		  
     	 </if> 
     		     
    </select>
    
    
    <select id="getDocInfo" parameterType="GlobalSearchVO" resultType="PrjDocumentIndexVO">
    	 	select *
			from p_prj_document_index ppdi 
			where prj_id = #{prj_id} and doc_id = #{doc_id} and rev_id = #{rev_id}
    </select>
    
    
    
    
    
    
    
    
    
    
    
</mapper>