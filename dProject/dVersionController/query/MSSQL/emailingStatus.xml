<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="emailingStatusSqlMap">
	<select id="getEmailSendList" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		SELECT CONCAT(pu.user_kor_nm,' ',pci.code_nm) as operator ,ppi.prj_nm ,main.*
		from(
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'TR'
  		     left outer join p_prj_tr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all
		select esi.prj_id
			  ,esi.reg_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.tr_subject	
   	 	      ,ti.send_date as tr_send_date     		   
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'VTR'
  		     left outer join p_prj_vtr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
        union all
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'STR'
  		     left outer join p_prj_str_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,et.email_feature
		      ,et.email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.title as tr_subject
   	 	      ,ppci.send_recv_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'CORRESPONDENCE'
  		     left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.doc_no
  		     join p_prj_cordoc_info ppci on esi.prj_id=ppci.prj_id and esi.user_data00=ppci.corr_no
		where esi.prj_id = #{prj_id}
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select distinct esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,'GR' as email_feature
		      ,'General' as email_type		    
		      ,ti.doc_no as user_data00
		      ,esi.subject
		      ,convert(nvarchar(max),esi.contents) as contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.title as tr_subject
   	 	      ,'' as tr_send_date
		from p_prj_email_send_info esi
             left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and ti.doc_id in(SELECT substring(value,1,10) doc_id from String_split(replace(replace(user_data00,'@@','@'),'&amp;&amp;','&amp;'),'@'))
		where esi.prj_id = #{prj_id}			
		and esi.email_type_id = 0
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		) main left outer join p_users pu on main.reg_id = pu.user_id 
	   	       left outer join p_code_info pci on pu.job_tit_cd = pci.code and pci.code_gubun = 'JOB'
	   	       left outer join p_prj_info ppi on main.prj_id = ppi.prj_id 
		order by main.email_send_date desc
	</select>
	
	<select id="getEmailSendList_all" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		SELECT CONCAT(pu.user_kor_nm,' ',pci.code_nm) as operator ,ppi.prj_nm ,main.*
		from(
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'TR'
  		     left outer join p_prj_tr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
  		where 1=1
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all
		select esi.prj_id
			  ,esi.reg_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.tr_subject	
   	 	      ,ti.send_date as tr_send_date     		   
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'VTR'
  		     left outer join p_prj_vtr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
  		where 1=1
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
        union all
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'STR'
  		     left outer join p_prj_str_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
  		where 1=1
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,et.email_feature
		      ,et.email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.title as tr_subject
   	 	      ,ppci.send_recv_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'CORRESPONDENCE'
  		     left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.doc_no
  		     join p_prj_cordoc_info ppci on esi.prj_id=ppci.prj_id and esi.user_data00=ppci.corr_no
		where 1=1
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select distinct esi.prj_id
			  ,esi.reg_id 
		      ,esi.email_type_id
		      ,'GR' as email_feature
		      ,'General' as email_type		    
		      ,ti.doc_no as user_data00
		      ,esi.subject
		      ,convert(nvarchar(max),esi.contents) as contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.title as tr_subject
   	 	      ,'' as tr_send_date
		from p_prj_email_send_info esi
             left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and ti.doc_id in(SELECT substring(value,1,10) doc_id from String_split(replace(replace(user_data00,'@@','@'),'&amp;&amp;','&amp;'),'@'))		
		where 1=1
		and esi.email_type_id = 0
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		) main left outer join p_users pu on main.reg_id = pu.user_id 
	   	       left outer join p_code_info pci on pu.job_tit_cd = pci.code and pci.code_gubun = 'JOB'
	   	       left outer join p_prj_info ppi on main.prj_id = ppi.prj_id 
	   	 WHERE 1=1
	   	 <if test="from != '' ">
			and substring(main.email_send_date,1,8) between #{from} and #{to}
		</if>
		order by main.email_send_date desc
	</select>
	
	
	<select id="getEmailReceiptList" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'TR'
  		     left outer join p_prj_tr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and esi.email_receiverd_date is not null and esi.email_receiverd_date != ''
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.tr_subject	
   	 	      ,ti.send_date as tr_send_date     		   
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'VTR'
  		     left outer join p_prj_vtr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and esi.email_receiverd_date is not null and esi.email_receiverd_date != ''
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
        union all
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'STR'
  		     left outer join p_prj_str_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and esi.email_receiverd_date is not null and esi.email_receiverd_date != ''
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select esi.prj_id
		      ,esi.email_type_id
		      ,et.email_feature
		      ,et.email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.title as tr_subject
   	 	      ,ppci.send_recv_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'CORRESPONDENCE'
  		     left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.doc_no
  		     join p_prj_cordoc_info ppci on esi.prj_id=ppci.prj_id and esi.user_data00=ppci.corr_no
		where esi.prj_id = #{prj_id}
		and esi.email_receiverd_date is not null and esi.email_receiverd_date != ''
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select distinct esi.prj_id
		      ,esi.email_type_id
		      ,'GR' as email_feature
		      ,'General' as email_type		    
		      ,ti.doc_no as user_data00
		      ,esi.subject
		      ,convert(nvarchar(max),esi.contents) as contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.title as tr_subject
   	 	      ,'' as tr_send_date
		from p_prj_email_send_info esi
             left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and ti.doc_id in(SELECT substring(value,1,10) doc_id from String_split(replace(replace(user_data00,'@@','@'),'&amp;&amp;','&amp;'),'@'))
		where esi.prj_id = #{prj_id}		
		and esi.email_receiverd_date is not null and esi.email_receiverd_date != ''	
		and esi.email_type_id = 0
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		order by email_send_date desc
	</select>
	<select id="getEmailNreceiptList" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'TR'
  		     left outer join p_prj_tr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and (esi.email_receiverd_date is null or esi.email_receiverd_date = '')
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.tr_subject	
   	 	      ,ti.send_date as tr_send_date     		   
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'VTR'
  		     left outer join p_prj_vtr_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and (esi.email_receiverd_date is null or esi.email_receiverd_date = '')
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
        union all
		select esi.prj_id
		      ,esi.email_type_id
		      ,case when esi.email_type_id = 0 then 'GR'
		       else et.email_feature
		       end email_feature
		      ,case when esi.email_type_id = 0 then 'General'
		       else et.email_type
		       end email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.tr_subject
   	 	      ,ti.send_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'STR'
  		     left outer join p_prj_str_info ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.tr_no
		where esi.prj_id = #{prj_id}
		and (esi.email_receiverd_date is null or esi.email_receiverd_date = '')
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select esi.prj_id
		      ,esi.email_type_id
		      ,et.email_feature
		      ,et.email_type
		      ,esi.user_data00
		      ,esi.subject
		      ,esi.contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc
   	 	      ,ti.title as tr_subject
   	 	      ,ppci.send_recv_date as tr_send_date
		from p_prj_email_send_info esi
		     join p_prj_email_type et on esi.prj_id = et.prj_id and esi.email_type_id = et.email_type_id and et.email_feature = 'CORRESPONDENCE'
  		     left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and esi.user_data00 = ti.doc_no
  		     join p_prj_cordoc_info ppci on esi.prj_id=ppci.prj_id and esi.user_data00=ppci.corr_no
		where esi.prj_id = #{prj_id}
		and (esi.email_receiverd_date is null or esi.email_receiverd_date = '')
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		union all		
		select distinct esi.prj_id
		      ,esi.email_type_id
		      ,'GR' as email_feature
		      ,'General' as email_type		    
		      ,ti.doc_no as user_data00
		      ,esi.subject
		      ,convert(nvarchar(max),esi.contents) as contents
		      ,esi.email_send_date
		      ,esi.email_receiverd_date
		      ,esi.email_sender_addr
		      ,REPLACE(convert(varchar(max), esi.email_receiver_addr),';',', ') AS email_receiver_addr
         	  ,REPLACE(convert(varchar(max), esi.email_refer_to),';',', ') AS email_refer_to
   	 	      ,REPLACE(convert(varchar(max), esi.email_bcc),';',', ') AS email_bcc	
   	 	      ,ti.title as tr_subject
   	 	      ,'' as tr_send_date
		from p_prj_email_send_info esi
             left outer join p_prj_document_index ti on esi.prj_id = ti.prj_id and ti.doc_id in(SELECT substring(value,1,10) doc_id from String_split(replace(replace(user_data00,'@@','@'),'&amp;&amp;','&amp;'),'@'))
		where esi.prj_id = #{prj_id}
		and (esi.email_receiverd_date is null or esi.email_receiverd_date = '')
		and esi.email_type_id = 0
		<if test="from != '' ">
			and substring(esi.email_send_date,1,8) between #{from} and #{to}
		</if>
		order by email_send_date desc
	</select>
	<select id="getEmailDownList" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		select ppi.prj_nm ,main.*
		from(
			select a.prj_id,case when b.email_type is null then 'General'
				       else b.email_type
				       end email_type,
				       case when b.email_type is null then a.doc_no
				       else c.user_data00
				       end tr_no, 
				       c.subject, c.email_send_date, a.doc_no, a.rev_no, a.down_date, a.down_ip
				from p_prj_email_attach_info a 
				LEFT OUTER JOIN p_prj_email_type b
				on a.prj_id=b.prj_id and a.email_type_id=b.email_type_id
				LEFT OUTER JOIN p_prj_email_send_info c
				on a.prj_id=c.prj_id and a.email_type_id=c.email_type_id and a.email_id=c.email_id
				where a.prj_id = #{prj_id}
				and a.down_date is not null and a.down_date != ''
				<if test="from != '' ">
				and substring(c.email_send_date,1,8) between #{from} and #{to}
				</if>
			) main join p_prj_info ppi on(main.prj_id = ppi.prj_id)
			order by main.down_date desc
	</select>
	
	<select id="getEmailDownList_all" resultType="PrjEmailTypeVO" parameterType="PrjEmailTypeVO">
		select ppi.prj_nm ,main.*
		from(
			select a.prj_id,case when b.email_type is null then 'General'
				       else b.email_type
				       end email_type,
				       case when b.email_type is null then a.doc_no
				       else c.user_data00
				       end tr_no, 
				       c.subject, c.email_send_date, a.doc_no, a.rev_no, a.down_date, a.down_ip
				from p_prj_email_attach_info a 
				LEFT OUTER JOIN p_prj_email_type b
				on a.prj_id=b.prj_id and a.email_type_id=b.email_type_id
				LEFT OUTER JOIN p_prj_email_send_info c
				on a.prj_id=c.prj_id and a.email_type_id=c.email_type_id and a.email_id=c.email_id
				where
				a.down_date is not null and a.down_date != ''
				<if test="from != '' ">
				and substring(c.email_send_date,1,8) between #{from} and #{to}
				</if>
			) main join p_prj_info ppi on(main.prj_id = ppi.prj_id)
			order by main.down_date desc
	</select>
</mapper>