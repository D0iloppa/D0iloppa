<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="homeSqlMap">

	
	<select id="getBBS" parameterType="ProjectNoticeVO" resultType="ProjectNoticeVO">
		<!-- SELECT TOP 10 *
		FROM p_prj_bbs_contents
		WHERE contents_type = 'N'
		OR prj_id = #{prj_id}
		ORDER BY bbs_seq desc -->
		SELECT TOP 10 main.prj_id, main.bbs_seq, main.contents_type, main.parent_no
		       ,main.order_no, main.depth_no, main.title, main.contents_type
		       ,main.hit_cnt, main.remote_ip, main.reg_id, main.reg_date, b.user_kor_nm, c.code_nm
		FROM (
				select *				
				from p_prj_bbs_contents
				where contents_type = 'N'
				union all
				select *
				from p_prj_bbs_contents
				where prj_id = #{prj_id}
				and contents_type = 'C'
		)main LEFT OUTER JOIN p_users AS b		
		on main.reg_id=b.user_id
		LEFT OUTER JOIN p_code_info AS c
		on c.code_gubun = 'JOB'
		and b.job_tit_cd = c.code
		order by main.reg_date desc, main.contents_type desc
    </select>
    
    <select id="getBBSHitup" parameterType="ProjectBbsVO" resultType="ProjectBbsVO">
		SELECT *
		FROM p_prj_bbs_contents
		ORDER BY bbs_seq DESC
    </select>
    
    <!-- <select id="getHomeContDetail" parameterType="ProjectBbsVO" resultType="ProjectBbsVO">
    	select *
    	from p_prj_bbs_contents
    	where bbs_seq = #{bbs_seq}
    </select> -->
    
    <update id="hitcntUp" parameterType="ProjectBbsVO">
		update p_prj_bbs_contents
		set hit_cnt = (select hit_cnt+1 from p_prj_bbs_contents where bbs_seq = #{bbs_seq})
		where bbs_seq = #{bbs_seq}
		and prj_id = #{prj_id}
	</update>
    
    
    
    <select id="getDrnsummary" parameterType="DrnLineVO" resultType="DrnLineVO">
	    SELECT ppdi2.prj_id,ppdi.drn_id,ppdi2.doc_id,ppdi2.rev_id,ppdi2.doc_no,ppdi2.title,ppcs.set_code as revision, di.discip_code_id ,di.discip_code, di.discip_display ,ppdi.reg_date ,ppdal.reg_id, ppdal.reviewed_id ,ppdal.approved_id,ppdi.drn_approval_status
		FROM p_prj_drn_attch_file ppdaf 
			 LEFT OUTER JOIN p_prj_drn_info ppdi ON (ppdaf.prj_id = ppdi.prj_id AND ppdaf.drn_id = ppdi.drn_id)
			 LEFT OUTER JOIN p_prj_drn_approval_line ppdal ON (ppdi.prj_id = ppdal.prj_id AND ppdi.approval_id = ppdal.approval_id)
			 LEFT OUTER JOIN p_prj_document_index ppdi2 ON(ppdaf.prj_id = ppdi2.prj_id AND ppdaf.doc_id = ppdi2.doc_id AND ppdaf.rev_id = ppdi2.rev_id)
			 LEFT OUTER JOIN p_prj_code_settings ppcs ON (ppdi2.prj_id = ppcs.prj_id AND ppdi2.rev_code_id = ppcs.set_code_id AND ppcs.set_code_type = 'REVISION NUMBER')
			 LEFT OUTER JOIN (p_prj_folder_info fi
			 	LEFT OUTER JOIN p_prj_discipline_folder_info dfi ON fi.prj_id = dfi.prj_id AND dfi.discip_folder_id IN (SELECT value FROM STRING_SPLIT(fi.folder_path,'>') )
				LEFT OUTER JOIN p_prj_discipline_info di ON(dfi.prj_id = di.prj_id AND dfi.discip_code_id = di.discip_code_id) )
			 ON (ppdi2.prj_id = fi.prj_id AND ppdi2.folder_id = fi.folder_id)
		WHERE ppdaf.prj_id = #{prj_id} AND (ppdi.drn_approval_status != 'C' AND ppdi.drn_approval_status != 'R')
<!-- 	WHERE ppdaf.prj_id = #{prj_id} AND ppdi.mod_date <![CDATA[ >= ]]> #{reg_date}  AND (ppdi.drn_approval_status != 'C' or ppdi.drn_approval_status != 'T') -->
    </select>
    
    <select id="getDesigner" parameterType="DrnLineVO" resultType="DrnLineVO">
		SELECT ISNULL(ppei.designer_id,ISNULL(ppvi.designer_id,ppsi.designer_id)) as designed_id , user_kor_nm , pci.code_nm as type
		FROM p_prj_document_index ppdi LEFT OUTER JOIN p_prj_eng_info ppei ON ppdi.prj_id = ppei.prj_id AND ppdi.doc_id = ppei.doc_id AND ppdi.rev_id = ppei.rev_id 
			LEFT OUTER JOIN p_prj_vdr_info ppvi ON ppdi.prj_id = ppvi.prj_id AND ppdi.doc_id = ppvi.doc_id AND ppdi.rev_id = ppvi.rev_id
			LEFT OUTER JOIN p_prj_sdc_info ppsi ON ppdi.prj_id = ppsi.prj_id AND ppdi.doc_id = ppsi.doc_id AND ppdi.rev_id = ppsi.rev_id
			LEFT OUTER JOIN p_users pu ON (pu.user_id = ISNULL(ppei.designer_id,ISNULL(ppvi.designer_id,ppsi.designer_id)) )
			LEFT OUTER JOIN p_code_info pci ON (pci.code_gubun = 'JOB' AND pu.job_tit_cd = pci.code)
		WHERE ppdi.prj_id = #{prj_id} AND ppdi.doc_id = #{doc_id} AND ppdi.rev_id = #{rev_id}
    </select>
    
    <select id="getDrnDesigner" parameterType="DrnLineVO" resultType="DrnLineVO">
		SELECT ppdi.reg_id as designed_id , user_kor_nm , pci.code_nm as type
		FROM p_prj_drn_info ppdi 
			LEFT OUTER JOIN p_users pu ON (pu.user_id = ppdi.reg_id  )
			LEFT OUTER JOIN p_code_info pci ON (pci.code_gubun = 'JOB' AND pu.job_tit_cd = pci.code)
		WHERE ppdi.prj_id = #{prj_id} AND ppdi.drn_id = #{drn_id}
    </select>
    
    <select id="statusUserInfo" parameterType="String" resultType="DrnLineVO">
		SELECT pu.user_id, pu.user_kor_nm , pci.code_nm as type
		FROM p_users pu LEFT OUTER JOIN p_code_info pci ON (pci.code_gubun = 'JOB' AND pu.job_tit_cd = pci.code)
		WHERE pu.user_id = #{value}
    </select>
    
    <select id="getDccUser" parameterType="String" resultType="String">
		SELECT TOP 1 user_id
		FROM p_prj_member
		where prj_id = #{value} AND dcc_yn = 'Y'		
    </select>
    
    <select id="getRejectId" parameterType="DrnLineVO" resultType="String">
    	SELECT TOP 1 reg_id
		FROM p_prj_drn_info_hist
		where prj_id = #{prj_id} AND drn_id = #{drn_id} AND drn_approval_status = 'R'
		order by reg_date desc
    </select>
    
    <select id="getOutgoingTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_tr_info 
		WHERE prj_id = #{prj_id} AND inout = 'OUT' AND reg_date >= #{reg_date}
    </select>
    
     <select id="getOutgoingVTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_vtr_info 
		WHERE prj_id = #{prj_id} AND inout = 'OUT' AND reg_date >= #{reg_date}
    </select>
    
     <select id="getIncomingTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_tr_info
		WHERE prj_id = #{prj_id} AND inout = 'IN' AND reg_date >= #{reg_date}
    </select>
    
      <select id="getIncomingVTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_vtr_info
		WHERE prj_id = #{prj_id} AND inout = 'IN' AND reg_date >= #{reg_date}
    </select>
    
     <select id="getOutgoingSTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_str_info
		WHERE prj_id = #{prj_id} AND inout = 'OUT' AND reg_date >= #{reg_date}
    </select>
    
      <select id="getIncomingSTR" parameterType="NotificationVO" resultType="Integer">
    	SELECT count(*)
		FROM p_prj_str_info
		WHERE prj_id = #{prj_id} AND inout = 'IN' AND reg_date >= #{reg_date}
    </select>
    
    <select id="getEngTodoList" parameterType="NotificationVO" resultType="NotificationVO">
	    select sub1.*
		from
		  (	select a.prj_id,c.prj_nm
				       , a.doc_no, a.doc_id, a.rev_id, a.title
				       ,a.rev_code_id
				       ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
				      ,(select c1.set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='ENGINEERING STEP' and c1.set_code_id = b.step_code_id) as step
				      ,b.plan_date
				      ,b.actual_date
				      ,b.fore_date
				      ,ei.designer_id
				      ,concat(u.user_kor_nm,' ' ,pco.code_nm) designer
				      ,pco.code_nm
				      ,DATEDIFF(DD, b.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) as delay_days
				      ,ei.discip_code_id
				      ,(select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=ei.prj_id and ppdi.discip_code_id=ei.discip_code_id) discipline
<!--				  ,(select c1.set_desc as set_desc from p_prj_code_settings c1 where c1.prj_id = ei.prj_id and c1.set_code_type ='CORRESPONDENCE RESPONSIBILITY' and c1.set_code_id = ei.discip_code_id) discipline -->				      
				      ,d.set_order
				      ,a.folder_id
				from p_prj_document_index a
				join p_prj_eng_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_eng_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='ENGINEERING STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')		
				)sub1,
		(	select a.prj_id, a.doc_id, a.rev_id
				      , min(d.set_order) set_order
				from p_prj_document_index a
				join p_prj_eng_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_eng_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='ENGINEERING STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')	
			     group by a.prj_id, a.doc_id, a.rev_id
		) sub2
		where sub1.prj_id = sub2.prj_id
		and sub1.doc_id = sub2.doc_id
		and sub1.rev_id = sub2.rev_id
		and sub1.set_order = sub2.set_order
		and DATEDIFF(DD, sub1.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) <![CDATA[ >= ]]> -7
		order by sub1.prj_id, sub1.doc_id, sub1.rev_id
    </select>
    
    <select id="getVdrTodoList" parameterType="NotificationVO" resultType="NotificationVO">
	    select sub1.*
		from
		  (	select a.prj_id,c.prj_nm
				       , a.doc_no, a.doc_id, a.rev_id, a.title
				       ,a.rev_code_id
				       ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
				      ,(select c1.set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='VENDOR DOC STEP' and c1.set_code_id = b.step_code_id) as step
				      ,b.plan_date
				      ,b.actual_date
				      ,b.fore_date
				      ,ei.designer_id
				      ,concat(u.user_kor_nm,' ' ,pco.code_nm) designer
				      ,pco.code_nm
				      ,DATEDIFF(DD, b.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) as delay_days
				      ,ei.discip_code_id
				      ,(select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=ei.prj_id and ppdi.discip_code_id=ei.discip_code_id) discipline
				      ,d.set_order
				      ,a.folder_id
				from p_prj_document_index a
				join p_prj_vdr_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_vdr_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='VENDOR DOC STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')		
				)sub1,
		(	select a.prj_id, a.doc_id, a.rev_id
				      , min(d.set_order) set_order
				from p_prj_document_index a
				join p_prj_vdr_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_vdr_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='VENDOR DOC STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')	
			     group by a.prj_id, a.doc_id, a.rev_id
		) sub2
		where sub1.prj_id = sub2.prj_id
		and sub1.doc_id = sub2.doc_id
		and sub1.rev_id = sub2.rev_id
		and sub1.set_order = sub2.set_order
		and DATEDIFF(DD, sub1.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) <![CDATA[ >= ]]> -7
		order by sub1.prj_id, sub1.doc_id, sub1.rev_id
    </select>
    
    
    <select id="getSdcTodoList" parameterType="NotificationVO" resultType="NotificationVO">
	    select sub1.*
		from
		  (	select a.prj_id,c.prj_nm
				       , a.doc_no, a.doc_id, a.rev_id, a.title
				       ,a.rev_code_id
				       ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
				      ,(select c1.set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='SITE DOC STEP' and c1.set_code_id = b.step_code_id) as step
				      ,b.plan_date
				      ,b.actual_date
				      ,b.fore_date
				      ,ei.designer_id
				      ,concat(u.user_kor_nm,' ' ,pco.code_nm) designer
				      ,pco.code_nm
				      ,DATEDIFF(DD, b.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) as delay_days
				      ,ei.discip_code_id
				      ,(select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=ei.prj_id and ppdi.discip_code_id=ei.discip_code_id) discipline
				      ,d.set_order
				      ,a.folder_id
				from p_prj_document_index a
				join p_prj_sdc_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_sdc_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='SITE DOC STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')		
				)sub1,
		(	select a.prj_id, a.doc_id, a.rev_id
				      , min(d.set_order) set_order
				from p_prj_document_index a
				join p_prj_sdc_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_sdc_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='SITE DOC STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')	
			     group by a.prj_id, a.doc_id, a.rev_id
		) sub2
		where sub1.prj_id = sub2.prj_id
		and sub1.doc_id = sub2.doc_id
		and sub1.rev_id = sub2.rev_id
		and sub1.set_order = sub2.set_order
		and DATEDIFF(DD, sub1.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) <![CDATA[ >= ]]> -7
		order by sub1.prj_id, sub1.doc_id, sub1.rev_id
    </select>
    
    <select id="getProTodoList" parameterType="NotificationVO" resultType="NotificationVO">
	    select sub1.*
		from
		  (	select a.prj_id,c.prj_nm
				       , a.doc_no, a.doc_id, a.rev_id, a.title
				       ,a.rev_code_id
				       ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
				      ,(select c1.set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = b.step_code_id) as step
				      ,b.plan_date
				      ,b.actual_date
				      ,b.fore_date
				      ,ei.designer_id
				      ,concat(u.user_kor_nm,' ' ,pco.code_nm) designer
				      ,pco.code_nm
				      ,DATEDIFF(DD, b.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) as delay_days
				      ,ei.discip_code_id
				      ,(select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=ei.prj_id and ppdi.discip_code_id=ei.discip_code_id) discipline
				      ,d.set_order
				      ,a.folder_id
				from p_prj_document_index a
				join p_prj_pro_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_pro_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='PROCUREMENT STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')		
				)sub1,
		(	select a.prj_id, a.doc_id, a.rev_id
				      , min(d.set_order) set_order
				from p_prj_document_index a
				join p_prj_pro_info ei on a.prj_id  = ei.prj_id and a.doc_id = ei.doc_id and a.rev_id = ei.rev_id
				join p_prj_pro_step b on a.prj_id  = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
				join p_prj_info c on a.prj_id = c.prj_id
				join p_users u on u.user_id = ei.designer_id
				left outer join p_code_info pco on pco.code_gubun = 'JOB' and u.job_tit_cd = pco.code	
				,(select *
				 from p_prj_code_settings c1
				 where c1.set_code_type ='PROCUREMENT STEP'
				) d
				,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'					
							group by prj_id, doc_id)a1						
				where 1=1
				and a.prj_id = a1.prj_id
				and a.doc_id  = a1.doc_id
				and a.rev_id  = a1.rev_id
				and a.prj_id  = d.prj_id
			    and b.step_code_id = d.set_code_id
				and b.fore_date is not null and b.fore_date != ''
				and (b.actual_date is null or b.actual_date='')	
			     group by a.prj_id, a.doc_id, a.rev_id
		) sub2
		where sub1.prj_id = sub2.prj_id
		and sub1.doc_id = sub2.doc_id
		and sub1.rev_id = sub2.rev_id
		and sub1.set_order = sub2.set_order
		and DATEDIFF(DD, sub1.fore_date, Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)) <![CDATA[ >= ]]> -7
		order by sub1.prj_id, sub1.doc_id, sub1.rev_id
    </select>
    
    <select id="getCorrStatus" parameterType="NotificationVO" resultType="Integer">
	    SELECT count(*)
		FROM p_prj_cordoc_info ppci
		WHERE prj_id = #{prj_id} AND reg_date <![CDATA[ >= ]]> #{reg_date} and in_out = #{in_out}
    </select>
    
    <select id="getCorrList" parameterType="NotificationVO" resultType="NotificationVO">
    	SELECT pppi.process_type ,ppfi.folder_path, ppci.*
		FROM p_prj_cordoc_info ppci left outer join p_prj_folder_info ppfi  on ppci.prj_id = ppfi.prj_id and ppci.folder_id  = ppfi.folder_id
			join p_prj_process_info pppi on ppfi.prj_id = pppi.prj_id and pppi.process_folder_path_id In (select value from string_split(ppfi.folder_path,'>')) and pppi.process_type != 'CORRESPONDENCE'
		WHERE ppci.prj_id = #{prj_id} AND ppci.reg_date <![CDATA[ >= ]]> #{reg_date} and in_out = #{in_out}
    </select>
    
    <select id="getCrDelay" parameterType="NotificationVO" resultType="int">
    	SELECT count(*)
		FROM p_prj_cordoc_info ppci
		WHERE prj_id = #{prj_id} 
			AND IN_OUT = #{in_out}
			AND replyreqdate != '' 
			AND #{reg_date} <![CDATA[ >= ]]> replyreqdate 
    </select>
    
     <select id="getCrDelayList" parameterType="NotificationVO" resultType="PrjDocumentIndexVO">
    	SELECT prj_id, doc_id, rev_id, replyreqdate
		FROM p_prj_cordoc_info 
		WHERE prj_id = #{prj_id} 
			AND folder_id = #{folder_id}
			AND replyreqdate != '' 
			AND #{reg_date} <![CDATA[ >= ]]> replyreqdate 
    </select>
    
    <select id="getUserType" parameterType="String" resultType="String">
		SELECT user_type
		FROM p_users
		WHERE user_id = #{value}
	</select>
	
	<select id="getCRTabInfo" parameterType="FolderInfoVO" resultType="FolderInfoVO">
		SELECT pppi.process_type , dbo.fn_getFolderNm(ppfi.prj_id,ppfi.folder_id) as folder_path_str , ppfi.*
		FROM p_prj_folder_info ppfi left outer join p_prj_process_info pppi on (ppfi.prj_id = pppi.prj_id and ppfi.folder_id = pppi.process_folder_path_id) 
		WHERE ppfi.prj_id = #{prj_id} and process_type = #{folder_type}
	</select>
	
	<select id="getCRSuvTabInfo" parameterType="FolderInfoVO" resultType="FolderInfoVO">
		SELECT dbo.fn_getFolderNm(ppfi.prj_id,ppfi.folder_id) as folder_path_str , ppfi.*
		FROM p_prj_folder_info ppfi
		WHERE ppfi.prj_id = #{prj_id} AND
			  ppfi.folder_nm LIKE #{inOut} AND 
			  (#{folder_id} IN (SELECT value FROM STRING_SPLIT(ppfi.folder_path,'>')))
		
	</select>

    
    
</mapper>