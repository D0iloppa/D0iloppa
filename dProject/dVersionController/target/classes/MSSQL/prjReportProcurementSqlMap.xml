<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="prjReportProcurementSqlMap">
	<select id="PrjReportProcurementData_1" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discipline,'_') as discipline,
			isnull(doc_no,'-') as doc_no,
			isnull(rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			'Plan@,@Forecast@,@Actual' as type,
			STRING_AGG(case when isnull(step, '') = '' then '-' else step end, '@,@') WITHIN GROUP(ORDER BY set_order) as step,
			STRING_AGG(case when isnull(step_per, '') = '' then '-' else step_per end, '@,@') as step_per,
			STRING_AGG(case when isnull(plan_date, '') = '' then '-' else plan_date end, '@,@') as plan_date,
			STRING_AGG(case when isnull(fore_date, '') = '' then '-' else fore_date end, '@,@') as fore_date,
			STRING_AGG(case when isnull(actual_date, '') = '' then '-' else actual_date end, '@,@') as actual_date,
			isnull(wbs_code,'-') as wbs_code,
			isnull(deginer,'-') as deginer,
			case when remark = '' then '-' else remark end as remark
		from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, sub1.actual_date, sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			<if test='discipline!=null &amp;&amp; !discipline.equals("0")'>
				and discip_code_id = #{discipline}
			</if>
		) aa  
		group by  discip_code_id,doc_id,discipline,doc_no,rev_no,title,wbs_code,deginer,remark
		order by discipline asc,doc_no asc,plan_date asc
	</select>

	<select id="PrjReportProcurementData_2" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discipline,'_') as discipline,
			isnull(doc_no,'-') as doc_no,
			isnull(rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			'Plan@,@Forecast@,@Actual' as type,
			STRING_AGG(case when isnull(step, '') = '' then '-' else step end, '@,@') WITHIN GROUP(ORDER BY set_order) as step,
			STRING_AGG(case when isnull(step_per, '') = '' then '-' else step_per end, '@,@') as step_per,
			STRING_AGG(case when isnull(plan_date, '') = '' then '-' else plan_date end, '@,@') as plan_date,
			STRING_AGG(case when isnull(fore_date, '') = '' then '-' else fore_date end, '@,@') as fore_date,
			STRING_AGG(case when isnull(actual_date, '') = '' then '-' else actual_date end, '@,@') as actual_date,
			isnull(wbs_code,'-') as wbs_code,
			isnull(deginer,'-') as deginer,
			case when remark = '' then '-' else remark end as remark,
			isnull(vendor_nm,'-') as vendor,
			del_yn
		from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, sub1.actual_date, sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
			     , sub1.del_yn
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			<if test='del_yn!=null &amp;&amp; del_yn.equals("")'>
				and del_yn!='Y'
			</if>
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			<if test='discipline!=null &amp;&amp; !discipline.equals("0")'>
				and discip_code_id = #{discipline}
			</if>
		) aa  
		group by  discip_code_id,doc_id,discipline,doc_no,rev_no,title,wbs_code,deginer,remark,vendor_nm,del_yn
		order by discipline asc,doc_no asc,plan_date asc
	</select>
	
	<select id="PrjReportProcurementData_3" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discipline,'_') as discipline,
			isnull(doc_no,'-') as doc_no,
			isnull(aa.rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			isnull(plan_date,'-') as plan_date,
			isnull(actual_date,'-') as actual_date,
			isnull(fore_date,'-') as fore_date,
			isnull(foredate,'-') as foredate,
			DATEDIFF(DD, foredate, actualdate) as delay_days,
			isnull(wbs_code,'-') as wbs_code,
			isnull(deginer,'-') as deginer,
			isnull(step,'-') as work_step,
			case when remark = '' then '-' else remark end as remark
		from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			<!-- and actual_date <![CDATA[ <= ]]> #{cut_off_date} -->
			and plan_date <![CDATA[ <= ]]> #{cut_off_date}
			and plan_date != ''
			<if test='allBehindList.equals("All")'>
				and plan_date <![CDATA[ < ]]> actual_date
			</if>
			<if test='allBehindList.equals("")'>
				and ( actual_date is null or actual_date='' )			
			</if>
		) aa
		<!-- where ((actual_date!='' or actual_date is not null) and foredate <![CDATA[ < ]]> actual_date) or (actual_date='' or actual_date is null) -->
		where 1=1
		<if test='discipline!=null &amp;&amp; !discipline.equals("0")'>
			and discip_code_id = #{discipline}
		</if>
		<if test='workStep!=null &amp;&amp; !workStep.equals("0")'>
			and step_code_id = #{workStep}
		</if>
		group by discipline,doc_id,doc_no,rev_no,title,wbs_code,step,plan_date,actual_date,fore_date,foredate,actualdate,deginer,remark
		order by discipline asc,doc_no asc,plan_date asc
	</select>
	
	<select id="PrjReportProcurementData_4" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			isnull(discipline,'_') as discipline,
			isnull(doc_id,'-') as doc_id,
			isnull(doc_no,'-') as doc_no,
			isnull(rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			isnull(plan_date,'-') as plan_date,
			isnull(actual_date,'-') as actual_date,
			isnull(wbs_code,'-') as wbs_code,
			isnull(deginer,'-') as deginer,
			case when remark = '' then '-' else remark end as remark,
			isnull(wgtval, '0') as wgtval,
			isnull(step_code_id,'-') as step_code_id,
			isnull(step,'-') as work_step,
			isnull(step_per,'-') as step_per,
			case when (actual_date != '' and actual_date is not null) then '1' else '0' end as checkCnt,
			case when <!-- actual_date <![CDATA[ <= ]]> #{cut_off_date}
				and --> plan_date <![CDATA[ <= ]]> #{cut_off_date}
				and plan_date != ''
				and (actual_date is null or actual_date='')
			then '1' else '0' end as cutOffCnt
		from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
		) aa
		where discip_code=#{discip_code}
		and actual_date <![CDATA[ <= ]]> #{cut_off_date}
		group by folder_id,discipline,doc_id, doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per,set_order
		order by discipline, doc_no,
		set_order asc
	</select>
	
	<select id="PrjReportProcurementData_4_0" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			isnull(discipline,'_') as discipline,
			count(*) as total_index,
			sum( CAST(wgtval AS INT)) as wgtval
			from (
				select
				isnull(discip_code,'-') as discip_code,
				isnull(discipline,'_') as discipline,
				isnull(doc_id,'-') as doc_id,
				isnull(doc_no,'-') as doc_no,
				isnull(rev_no,'-') as rev_no,
				isnull(title,'-') as title,
				isnull(plan_date,'-') as plan_date,
				isnull(actual_date,'-') as actual_date,
				isnull(wbs_code,'-') as wbs_code,
				isnull(deginer,'-') as deginer,
				case when remark = '' then '-' else remark end as remark,
				isnull(wgtval, '0') as wgtval,
				isnull(step_code_id,'-') as step_code_id,
				isnull(step,'-') as work_step,
				isnull(step_per,'-') as step_per,
				case when (actual_date != '' and actual_date is not null) then '1' else '0' end as checkCnt,
				case when actual_date >= #{cut_off_date} then '1' else '0' end as cutOffCnt
			from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			) aa
			where actual_date <![CDATA[ <= ]]> #{cut_off_date}
			group by folder_id,discipline,doc_id, doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per
		) zz
		group by discip_code, discipline
		order by discip_code asc
	</select>
	
	
	<select id="PrjReportProcurementData_4_1" resultType="PrjReportProcurementVo" parameterType="ReportVo">
select doc_id from
		(select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			     )sub2
		where discip_code=#{discip_code}
		group by doc_id
	</select>
	
	<select id="getProcStepCount" resultType="int" parameterType="ReportVo">
		select count(*) from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='PROCUREMENT STEP'	
	</select>
	
	<select id="PrjReportProcurementData_5" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discipline,'_') as discipline,
			isnull(step,'-') as work_step,
			isnull(doc_no,'-') as doc_no,
			isnull(aa.rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			case when plan_date = '' then '-' else plan_date end as plan_date,
			case when actual_date = '' then '-' else actual_date end as actual_date,
			isnull(deginer,'-') as deginer,
			isnull(vendor_nm,'-') as vendor,
			case when remark = '' then '-' else remark end as remark
		from (
			select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			     	and (actual_date!='' or actual_date is not null)
			<if test='!discipline.equals("0")'>
				and discip_code_id = #{discipline}
			</if>
			<if test='durationCheck != "All"'>
				and actual_date >= #{date_s} and actual_date <![CDATA[ <= ]]>  #{date_d}
			</if>
		) aa
		group by discipline,doc_id,doc_no,rev_no,title,wbs_code,step,plan_date,actual_date,deginer,remark,vendor_nm
		order by discipline asc,doc_no asc,plan_date asc
	</select>
	
	<select id="PrjReportProcurementData_6" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			isnull(discipline,'_') as discipline,
			isnull(doc_no,'-') as doc_no,
			isnull(rev_no,'-') as rev_no,
			isnull(title,'-') as title,
			isnull(plan_date,'-') as plan_date,
			isnull(actual_date,'-') as actual_date,
			isnull(fore_date,'-') as fore_date,
			isnull(wbs_code,'-') as wbs_code,
			isnull(deginer,'-') as deginer,
			case when remark = '' then '-' else remark end as remark,
			isnull(wgtval, '0') as wgtval,
			isnull(step_code_id,'-') as step_code_id,
			isnull(step,'-') as work_step,
			isnull(step_per,'-') as step_per,
			case when (plan_date != '' and plan_date is not null) then '1' else '0' end as plan_cnt,
			case when (fore_date != '' and fore_date is not null) then '1' else '0' end as fore_cnt,
			case when (actual_date != '' and actual_date is not null) then '1' else '0' end as actual_cnt
		from (select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
			     	and (actual_date!='' or actual_date is not null)
								<if test='durationCheck != "All"'>
									and actual_date >= #{date_s} and actual_date <![CDATA[ <= ]]>  #{date_d}
								</if>
		) aa
		where discip_code=#{discip_code}
		group by discipline,discip_code,doc_id,doc_no,rev_no,title,wbs_code,wgtval,step,plan_date,fore_date,actual_date,deginer,remark,step_code_id,step_per,set_order
		order by discipline, doc_no, 
		set_order asc
	</select>
	
	<select id="PrjReportProcurementData_6_0" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			isnull(discipline,'_') as discipline,
			count(*) as total_index,
			sum( CAST(wgtval AS INT)) as wgtval
			from (
					select
						isnull(discip_code,'-') as discip_code,
						isnull(discipline,'_') as discipline,
						isnull(doc_no,'-') as doc_no,
						isnull(rev_no,'-') as rev_no,
						isnull(title,'-') as title,
						isnull(plan_date,'-') as plan_date,
						isnull(actual_date,'-') as actual_date,
						isnull(wbs_code,'-') as wbs_code,
						isnull(deginer,'-') as deginer,
						case when remark = '' then '-' else remark end as remark,
						isnull(wgtval, '1') as wgtval,
						isnull(step_code_id,'-') as step_code_id,
						isnull(step,'-') as work_step,
						isnull(step_per,'-') as step_per
					from (
					select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
					         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
					     , sub1.wbs_code_id, sub1.discip_code_id
					     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
						 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
					     , sub1.folder_id
					     , sub1.designer_id
					 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
					  from p_users u
					       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
					       where u.user_id = sub1.designer_id) as deginer
					     , sub1.step_code_id
					             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
					             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
					     , sub1.plan_date, sub1.fore_date, 
					     case when fore_date='' then plan_date
					     	when fore_date is null then plan_date
					     	else fore_date
					     	end foredate
					             , sub1.actual_date, 
					     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
					     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
					     	else actual_date
					     	end actualdate,
					     	sub1.step_seq
					             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
								  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
					     , sub1.remark
					     ,sub1.vendor_nm 
						 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
					from
					(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
					from p_prj_document_index a
		 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
					     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
					     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
					where 1=1
					and del_yn!='Y'
					group by prj_id, doc_id)a1
					where a.prj_id = #{prj_id}
					and a.prj_id = a1.prj_id
					and a.doc_id  = a1.doc_id
					and a.rev_id  = a1.rev_id	
					and a.doc_type='PCI'
					)sub1
					join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			    	where sub1.prj_id = #{prj_id}
					     	and (actual_date!='' or actual_date is not null)
								<if test='durationCheck != "All"'>
									and actual_date >= #{date_s} and actual_date <![CDATA[ <= ]]>  #{date_d}
								</if>
					) aa
					where discip_code is not null
					group by discipline,doc_id,doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per
		) zz
		group by discip_code, discipline
	</select>
	
	<select id="PrjReportProcurementData_7_0" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			isnull(discipline,'_') as discipline,
			sum( CAST(plan_cnt AS INT)) as plan_cnt,
			sum( CAST(fore_cnt AS INT)) as fore_cnt,
			sum( CAST(actual_cnt AS INT)) as actual_cnt,
			count(*) as total_index,
			sum(CONVERT(INT,isnull(wgtval, '1')) )as wgtval
			from
			(			
  			     select
                           isnull(discip_code,'-') as discip_code,
						   isnull(discipline,'_') as discipline,
						   isnull(doc_no,'-') as doc_no,
						   isnull(rev_no,'-') as rev_no,
						   isnull(title,'-') as title,
						   isnull(plan_date,'-') as plan_date,
						   isnull(actual_date,'-') as actual_date,
						   isnull(fore_date,'-') as fore_date,
                           isnull(wbs_code,'-') as wbs_code,
						   isnull(deginer,'-') as deginer,
                           case when remark = '' then '-' else remark end as remark,
                           isnull(wgtval, '1') as wgtval,
                           isnull(step_code_id,'-') as step_code_id,
						   isnull(step,'-') as work_step,
						   isnull(step_per,'-') as step_per,
                           case when plan_date != '' then '1' else '0' end as plan_cnt,
                           case when fore_date != '' then '1' else '0' end as fore_cnt,
                           case when actual_date != '' then '1' else '0' end as actual_cnt
                     from (
                          select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
                     ) aa
                     group by discipline,doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per,fore_date
              ) aaaa
              group by discip_code, discipline
              order by discip_code asc
	</select>
	
	<select id="PrjReportProcurementData_7" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select count(*) as total,
 					count(case when workdone_cnt=${step_cnt} then 1 end) as actual_cnt,
 					'plan' as step
 			from
 				(select 
 					count(step_code_id) as workdone_cnt from
 					(
 					select
 							doc_id,
                           isnull(discip_code,'-') as discip_code,
						   isnull(discipline,'_') as discipline,
						   isnull(doc_no,'-') as doc_no,
						   isnull(rev_no,'-') as rev_no,
						   isnull(title,'-') as title,
						   isnull(plan_date,'-') as plan_date,
						   isnull(actual_date,'-') as actual_date,
						   isnull(fore_date,'-') as fore_date,
                           isnull(wbs_code,'-') as wbs_code,
						   isnull(deginer,'-') as deginer,
                           case when remark = '' then '-' else remark end as remark,
                           isnull(wgtval, '1') as wgtval,
                           isnull(step_code_id,'-') as step_code_id,
						   isnull(step,'-') as work_step,
						   isnull(step_per,'-') as step_per,
                           case when (plan_date != '' and plan_date is not null) then '1' else '0' end as plan_cnt,
                           case when (fore_date != '' and fore_date is not null) then '1' else '0' end as fore_cnt,
                           case when (actual_date != '' and actual_date is not null) then '1' else '0' end as actual_cnt
                     from (
                           select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
                     ) aa
                     where plan_date <![CDATA[ <= ]]> #{date_s} and discip_code=#{discip_code}
                     group by discipline,doc_id,doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per,fore_date
              	)aaaa
              	where (plan_date != '' and plan_date is not null)
              	group by doc_id
          )main1
          union all
 			select count(*) as total,
 					count(case when workdone_cnt=${step_cnt} then 1 end) as actual_cnt,
 					'actual' as step
 			from
 				(select 
 					count(step_code_id) as workdone_cnt from
 					(
 					select
 							doc_id,
                           isnull(discip_code,'-') as discip_code,
						   isnull(discipline,'_') as discipline,
						   isnull(doc_no,'-') as doc_no,
						   isnull(rev_no,'-') as rev_no,
						   isnull(title,'-') as title,
						   isnull(plan_date,'-') as plan_date,
						   isnull(actual_date,'-') as actual_date,
						   isnull(fore_date,'-') as fore_date,
                           isnull(wbs_code,'-') as wbs_code,
						   isnull(deginer,'-') as deginer,
                           case when remark = '' then '-' else remark end as remark,
                           isnull(wgtval, '1') as wgtval,
                           isnull(step_code_id,'-') as step_code_id,
						   isnull(step,'-') as work_step,
						   isnull(step_per,'-') as step_per,
                           case when (plan_date != '' and plan_date is not null) then '1' else '0' end as plan_cnt,
                           case when (fore_date != '' and fore_date is not null) then '1' else '0' end as fore_cnt,
                           case when (actual_date != '' and actual_date is not null) then '1' else '0' end as actual_cnt
                     from (
                           select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
                     ) aa
                     where plan_date <![CDATA[ <= ]]> #{date_s} and discip_code=#{discip_code}
                     group by discipline,doc_id,doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per,fore_date
              	)aaaa
              	where (actual_date != '' and actual_date is not null)
              	group by doc_id
          )main2
          union all
          select count(*) as total,
 					count(case when workdone_cnt=${step_cnt} then 1 end) as actual_cnt,
 					'fore' as step
 			from
 				(select 
 					count(step_code_id) as workdone_cnt from
 					(
 					select
 							doc_id,
                           isnull(discip_code,'-') as discip_code,
						   isnull(discipline,'_') as discipline,
						   isnull(doc_no,'-') as doc_no,
						   isnull(rev_no,'-') as rev_no,
						   isnull(title,'-') as title,
						   isnull(plan_date,'-') as plan_date,
						   isnull(actual_date,'-') as actual_date,
						   isnull(fore_date,'-') as fore_date,
                           isnull(wbs_code,'-') as wbs_code,
						   isnull(deginer,'-') as deginer,
                           case when remark = '' then '-' else remark end as remark,
                           isnull(wgtval, '1') as wgtval,
                           isnull(step_code_id,'-') as step_code_id,
						   isnull(step,'-') as work_step,
						   isnull(step_per,'-') as step_per,
                           case when (plan_date != '' and plan_date is not null) then '1' else '0' end as plan_cnt,
                           case when (fore_date != '' and fore_date is not null) then '1' else '0' end as fore_cnt,
                           case when (actual_date != '' and actual_date is not null) then '1' else '0' end as actual_cnt
                     from (
                           select sub1.prj_id, sub1.doc_id, sub1.doc_no, sub1.title, sub1.rev_code_id, sub1.trans_ref_doc_id, sub1.rev_id
			         , (select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and sub1.rev_code_id = c1.set_code_id) rev_no
			     , sub1.wbs_code_id, sub1.discip_code_id
			     , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discipline
				 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
			     , sub1.folder_id
			     , sub1.designer_id
			 ,(select concat(u.user_kor_nm,' ',ci.code_nm)
			  from p_users u
			       left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code
			       where u.user_id = sub1.designer_id) as deginer
			     , sub1.step_code_id
			             ,(select c1.set_code as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step
			             ,(select c1.set_order  from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) set_order
			     , sub1.plan_date, sub1.fore_date, 
			     case when fore_date='' then plan_date
			     	when fore_date is null then plan_date
			     	else fore_date
			     	end foredate
			             , sub1.actual_date, 
			     case when actual_date='' then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	when actual_date is null then Convert(varchar(10),dbo.returnLocalDate(Getdate()),112)
			     	else actual_date
			     	end actualdate,
			     	sub1.step_seq
			             , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
						  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
			     , sub1.remark
			     ,sub1.vendor_nm 
				 , (select c1.set_val as set_desc from p_prj_code_settings c1 where sub1.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = sub1.step_code_id) step_per
			from
			(select a.*,b.vendor_nm,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
			from p_prj_document_index a
 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
			     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
			     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
			where 1=1
			and del_yn!='Y'
			group by prj_id, doc_id)a1
			where a.prj_id = #{prj_id}
			and a.prj_id = a1.prj_id
			and a.doc_id  = a1.doc_id
			and a.rev_id  = a1.rev_id	
			and a.doc_type='PCI'
			)sub1
			join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
			     where sub1.prj_id = #{prj_id}
                     ) aa
                     where plan_date <![CDATA[ <= ]]> #{date_s} and discip_code=#{discip_code}
                     group by discipline,doc_id,doc_no,rev_no,title,wbs_code,discip_code,plan_date,actual_date,deginer,remark,wgtval,step_code_id,step,step_per,fore_date
              	)aaaa
              	where (fore_date != '' and fore_date is not null)
              	group by doc_id
          )main3
	</select>
	<select id="PrjReportProcurementData_7_1" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
			isnull(discip_code,'-') as discip_code,
			sum(CONVERT(INT,isnull(wgtval, '0')) )as wgtval
			from
			(			
  			     select
                           isnull(discip_code,'-') as discip_code,
                           isnull(wbs_code,'-') as wbs_code,
                           isnull(wgtval, '0') as wgtval
                     from (
                          select (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wbs_code
								,(select c1.wgtval as set_desc from p_prj_wbs_code c1 where sub1.prj_id = c1.prj_id and c1.wbs_code_id = sub1.wbs_code_id) wgtval
								,(select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=sub1.prj_id and ppdi.discip_code_id=sub1.discip_code_id) discip_code
							from
							(select a.*,b.wbs_code_id, b.discip_code_id, b.designer_id, b.remark, c.step_code_id,c.plan_date, c.fore_date, c.actual_date, c.step_seq
							from p_prj_document_index a
				 				join p_prj_pro_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id
							     left outer join p_prj_pro_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id
							     ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1
							and del_yn!='Y'
							group by prj_id, doc_id)a1
							where a.prj_id = #{prj_id}
							and a.prj_id = a1.prj_id
							and a.doc_id  = a1.doc_id
							and a.rev_id  = a1.rev_id	
							and a.doc_type='PCI'	
							)sub1
							join p_prj_folder_info ppfi on sub1.prj_id=ppfi.prj_id and sub1.folder_id=ppfi.folder_id and folder_type='DCC'
							     where sub1.prj_id = #{prj_id}
                     ) aa
                     group by discip_code,wbs_code,wgtval
              ) aaaa
              group by discip_code
              order by discip_code asc
	</select>
	
	<select id="PrjReportProcurementData_8_0" resultType="PrjReportProcurementVo" parameterType="ReportVo">
	</select>
	
	<select id="PrjReportProcurementData_8" resultType="PrjReportProcurementVo" parameterType="ReportVo">
	</select>
	
	<select id="PrjReportProcurementData_9_0" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select 
			isnull(discipline,'_') as discipline,
			isnull(wbs_code,'-') as wbs_code,
			isnull(wbs_desc,'-') as wbs_desc,
			sum(checkCnt) as checkCnt,
			sum( CAST(plan_cnt AS INT)) as plan_cnt,
			sum( CAST(actual_cnt AS INT)) as actual_cnt
			from 
			(
			select
						    isnull(discipline,'_') as discipline,
							isnull(wbs_code,'-') as wbs_code,
						    isnull(doc_no,'_') as doc_no,
						    isnull(rev_no,'_') as rev_no,
						    isnull(title,'_') as title,
							isnull(tr_issuepur,'-') as tr_issuepur,
							isnull(plan_date,'-') as plan_date,
						    isnull(actual_date,'-') as actual_date,
						    isnull(fore_date,'-') as fore_date,
							isnull(doc_type,'-') as doc_type,
						    isnull(doc_size,'-') as doc_size,
						    isnull(deginer,'-') as deginer,
						    isnull(tr_no,'-') as tr_no,
						    isnull(send_date,'-') as send_date,
							case when remark = '' then '-' else remark end as remark,
							isnull(wgtval, '1') as wgtval,
							isnull(step_code_id,'-') as step_code_id,
						    isnull(step,'-') as work_step,
						    isnull(step_per,'-') as step_per,
							case when plan_date >= #{cut_off_date} then '1' else '0' end as plan_cnt,
							case when fore_date != '' then '1' else '0' end as fore_cnt,
							case when actual_date >= #{cut_off_date} then '1' else '0' end as actual_cnt,
							count(*) as checkCnt,
							isnull(wbs_desc,'-') as wbs_desc
						from ( 
							select a.prj_id, a.doc_id, a.doc_no, a.title, a.rev_code_id, a.trans_ref_doc_id, a.rev_id,tr.inout as inout,
									   ( select set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.CATEGORY' and a.rev_code_id = c1.set_code_id) category
									 , (select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
								 , b.wbs_code_id, b.discip_code_id
								 , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=a.prj_id and ppdi.discip_code_id=b.discip_code_id) discipline
								 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=a.prj_id and ppdi.discip_code_id=b.discip_code_id) discip_code
								 , b.folder_id, b.doc_type_id 
										 , (select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.TYPE' and c1.set_code_id = b.doc_type_id) doc_type     
								 , b.designer_id
							 ,(select concat(u.user_kor_nm,' ',ci.code_nm)  
							  from p_users u
								   left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code 
								   where u.user_id = b.designer_id) as deginer      
								 , b.size_code_id
								 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.SIZE' and c1.set_code_id = b.size_code_id) doc_size
								 , c.step_code_id
										 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) step     
										 ,(select c1.set_order  from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) set_order             
								 , c.plan_date, c.fore_date, c.actual_date, c.step_seq
										 , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wbs_code
										  , (select c1.wbs_desc as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wbs_desc
										  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wgtval
								 , tr.tr_no 
								 , tr.tr_issuepur_code_id
								 , tr.issued_rev_no
								 , tr.issued_send_date
								 , tr.rtn_status_code_id
								 , (select concat(c1.set_code, '_', c1.set_desc) as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='TR RETURN STATUS' and tr.rtn_status_code_id = c1.set_code_id) rtn_status_code
								 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='TR ISSUE PURPOSE' and c1.set_code_id = tr.tr_issuepur_code_id) tr_issuepur     
								 , tr.send_date
								 , b.remark 
								 , (select c1.set_val as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) step_per
							from p_prj_document_index a
								 join p_prj_eng_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id 
								 left outer join p_prj_eng_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id  
								 ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1 
							and del_yn!='Y'
							group by prj_id, doc_id)a1
							,(select tf.prj_id, tf.doc_id, tf.rev_id, tr.tr_no , tf.issue_step, tr.tr_issuepur_code_id,tr.send_date,tr.send_date as issued_send_date, tf.rev_no  as issued_rev_no, tf.rtn_status_code_id, inout 
							  from p_prj_tr_file tf
							  join p_prj_tr_info tr on tf.prj_id  = #{prj_id} and tf.prj_id = tr.prj_id 
													   and tf.tr_id = tr.tr_id ) tr      
							where a.prj_id = #{prj_id}
							<if test='!discipline.equals("0")'>
								and discip_code_id = #{discipline}
							</if>
							and a.prj_id = a1.prj_id 
							and a.doc_id  = a1.doc_id 
							and a.rev_id  = a1.rev_id 
							and a.prj_id = tr.prj_id 
							and a.doc_id = tr.doc_id 
							and a.rev_id = tr.rev_id 
						) aa
						group by discipline,doc_no,rev_no,title,tr_issuepur,wbs_code,doc_type,category,discip_code,plan_date,actual_date,doc_size,deginer,tr_no,send_date,remark,issued_rev_no,issued_send_date,rtn_status_code_id,rtn_status_code,wgtval,step_code_id,step,step_per,fore_date, wbs_desc
			) zz
			where wbs_code != '-'
			group by discipline, wbs_code, wbs_desc
			order by discipline asc
	</select>
	
	<select id="PrjReportProcurementData_9" resultType="PrjReportProcurementVo" parameterType="ReportVo">
		select
							isnull(discipline,'_') as discipline,
							isnull(remark,'-') as wbs_code,
							isnull(doc_no,'-') as doc_no,
							isnull(rev_no,'-') as rev_no,
							isnull(title,'-') as title,
							isnull(tr_issuepur,'-') as tr_issuepur,
							isnull(plan_date,'-') as plan_date,
							isnull(actual_date,'-') as actual_date,
							isnull(fore_date,'-') as fore_date,
							isnull(doc_type,'-') as doc_type,
							isnull(doc_size,'-') as doc_size,
							isnull(deginer,'-') as deginer,
							isnull(tr_no,'-') as tr_no,
							isnull(send_date,'-') as send_date,
							case when remark = '' then '-' else remark end as remark,
							isnull(wgtval, '1') as wgtval,
							isnull(step_code_id,'-') as step_code_id,
							isnull(step,'-') as work_step,
							isnull(step_per,'-') as step_per,
							case when plan_date >= #{cut_off_date} then '1' else '0' end as plan_cnt,
							case when fore_date != '' then '1' else '0' end as fore_cnt,
							case when actual_date >= #{cut_off_date} then '1' else '0' end as actual_cnt,
							isnull(wbs_desc,'-') as wbs_desc,
							count(*) as checkCnt
						from ( 
							select a.prj_id, a.doc_id, a.doc_no, a.title, a.rev_code_id, a.trans_ref_doc_id, a.rev_id,tr.inout as inout,
									   ( select set_code from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.CATEGORY' and a.rev_code_id = c1.set_code_id) category
									 , (select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='REVISION NUMBER' and a.rev_code_id = c1.set_code_id) rev_no
								 , b.wbs_code_id, b.discip_code_id
								 , (select ppdi.discip_display from p_prj_discipline_info ppdi where ppdi.prj_id=a.prj_id and ppdi.discip_code_id=b.discip_code_id) discipline
								 , (select ppdi.discip_code from p_prj_discipline_info ppdi where ppdi.prj_id=a.prj_id and ppdi.discip_code_id=b.discip_code_id) discip_code
								 , b.folder_id, b.doc_type_id 
										 , (select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.TYPE' and c1.set_code_id = b.doc_type_id) doc_type     
								 , b.designer_id
							 ,(select concat(u.user_kor_nm,' ',ci.code_nm)  
							  from p_users u
								   left outer join p_code_info ci on ci.code_gubun ='JOB' and u.job_tit_cd  = ci.code 
								   where u.user_id = b.designer_id) as deginer      
								 , b.size_code_id
								 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='DOC.SIZE' and c1.set_code_id = b.size_code_id) doc_size
								 , c.step_code_id
										 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) step     
										 ,(select c1.set_order  from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) set_order             
								 , c.plan_date, c.fore_date, c.actual_date, c.step_seq
										 , (select c1.wbs_code as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wbs_code
										  , (select c1.wbs_desc as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wbs_desc
										  , (select c1.wgtval as set_desc from p_prj_wbs_code c1 where a.prj_id = c1.prj_id and c1.wbs_code_id = b.wbs_code_id) wgtval
								 , tr.tr_no 
								 , tr.tr_issuepur_code_id
								 , tr.issued_rev_no
								 , tr.issued_send_date
								 , tr.rtn_status_code_id
								 , (select concat(c1.set_code, '_', c1.set_desc) as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='TR RETURN STATUS' and tr.rtn_status_code_id = c1.set_code_id) rtn_status_code
								 ,(select c1.set_code as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='TR ISSUE PURPOSE' and c1.set_code_id = tr.tr_issuepur_code_id) tr_issuepur     
								 , tr.send_date
								 , b.remark 
								 , (select c1.set_val as set_desc from p_prj_code_settings c1 where a.prj_id = c1.prj_id and c1.set_code_type ='PROCUREMENT STEP' and c1.set_code_id = c.step_code_id) step_per
							from p_prj_document_index a
								 join p_prj_eng_info b on a.prj_id = b.prj_id and a.doc_id = b.doc_id and a.rev_id = b.rev_id 
								 left outer join p_prj_eng_step c on a.prj_id = c.prj_id and a.doc_id = c.doc_id and a.rev_id =  c.rev_id  
								 ,(select prj_id, doc_id, max(rev_id) as rev_id from p_prj_document_index
							where 1=1 
							and del_yn!='Y'
							group by prj_id, doc_id)a1
							,(select tf.prj_id, tf.doc_id, tf.rev_id, tr.tr_no , tf.issue_step, tr.tr_issuepur_code_id,tr.send_date,tr.send_date as issued_send_date, tf.rev_no  as issued_rev_no, tf.rtn_status_code_id, inout 
							  from p_prj_tr_file tf
							  join p_prj_tr_info tr on tf.prj_id  = #{prj_id} and tf.prj_id = tr.prj_id 
													   and tf.tr_id = tr.tr_id ) tr      
							where a.prj_id = #{prj_id}
							and a.prj_id = a1.prj_id 
							and a.doc_id  = a1.doc_id 
							and a.rev_id  = a1.rev_id 
							and a.prj_id = tr.prj_id 
							and a.doc_id = tr.doc_id 
							and a.rev_id = tr.rev_id 
						) aa
						where wbs_code=#{wbs_code}
						group by discipline,doc_no,rev_no,title,tr_issuepur,wbs_code,doc_type,category,discip_code,plan_date,actual_date,doc_size,deginer,tr_no,send_date,remark,issued_rev_no,issued_send_date,rtn_status_code_id,rtn_status_code,wgtval,step_code_id,step,step_per,fore_date, wbs_desc
	</select>



</mapper>