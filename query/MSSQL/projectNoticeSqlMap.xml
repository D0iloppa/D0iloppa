<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="projectNoticeSqlMap">

	<!-- 선택한 게시판 등록 유저 확인 -->
	<select id="checkPrjUserId" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select a.reg_id from p_prj_bbs_contents  AS a LEFT OUTER JOIN p_users AS b
		on a.reg_id=b.user_id
		where bbs_seq = #{bbs_seq}
	</select>
	
	<select id="getProjectNoticeList" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select main.prj_id, main.bbs_seq, main.contents_type, main.parent_no
		       ,main.order_no, main.depth_no, main.title, main.contents_type
		       ,main.hit_cnt, main.remote_ip, main.reg_id, main.reg_date, b.user_kor_nm, c.code_nm
		FROM (
				select *				
				from p_prj_bbs_contents
				where contents_type = 'N'
				union all
				select *
				from p_prj_bbs_contents
				where prj_id = #{prj_id}
				and contents_type = 'C'
		)main LEFT OUTER JOIN p_users AS b		
		on main.reg_id=b.user_id
		LEFT OUTER JOIN p_code_info AS c
		on c.code_gubun = 'JOB'
		and b.job_tit_cd = c.code
		order by main.contents_type desc, main.reg_date desc
	</select>
	
	<select id="findNoticeList" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select main.prj_id, main.bbs_seq, main.contents_type, main.parent_no
		       ,main.order_no, main.depth_no, main.title, main.contents_type
		       ,main.hit_cnt, main.remote_ip, main.reg_id, main.reg_date, b.user_kor_nm, c.code_nm
		FROM (
				select *				
				from p_prj_bbs_contents
				where contents_type = 'N'
				union all
				select *
				from p_prj_bbs_contents
				where prj_id = #{prj_id}
				and contents_type = 'C'
		)main LEFT OUTER JOIN p_users AS b		
		on main.reg_id=b.user_id
		LEFT OUTER JOIN p_code_info AS c
		on c.code_gubun = 'JOB'
		and b.job_tit_cd = c.code
		<if test="searchAtc == 'all'">
			where user_kor_nm like concat('%',#{textAtc},'%')
			or title like concat('%',#{textAtc},'%')
			or contents like concat('%',#{textAtc},'%')
			and prj_id = #{prj_id}
		</if>
		<if test="searchAtc == 'title'">
			where title like concat('%',#{textAtc},'%')
			and prj_id = #{prj_id}
		</if>
		<if test="searchAtc == 'contents'">
			where contents like concat('%',#{textAtc},'%')
			and prj_id = #{prj_id}
		</if>
		order by main.contents_type desc, main.reg_date desc	
	</select>
	
	<select id="getPrjNoticeBoard" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select a.*, b.user_kor_nm, b.user_id, c.code_nm
		from p_prj_bbs_contents a join p_users b
		on a.reg_id = b.user_id
		LEFT OUTER JOIN p_code_info AS c
		on c.code_gubun = 'JOB'
		and b.job_tit_cd = c.code
		where prj_id = #{prj_id}
		and bbs_seq = #{bbs_seq}
	</select>
	
	<select id="getPrjNoticeFileList" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select b.rfile_nm, b.file_size, b.file_seq, b.file_path, b.sfile_nm
		from p_prj_bbs_contents AS a 
		LEFT OUTER JOIN p_prj_bbs_attach_file AS b
		on a.bbs_seq = b.bbs_seq and a.prj_id = b.prj_id		
		where a.prj_id = #{prj_id}
		and a.bbs_seq = #{bbs_seq}
	</select>
	
	<select id="getFilePath" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select file_path
		from p_prj_bbs_attach_file
		where sfile_nm = #{fullPath}
	</select>
	
	<select id="getDeleteFile" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select sfile_nm, file_path, prj_id
		from p_prj_bbs_attach_file
		where file_seq = #{file_seq}
		and prj_id = #{prj_id}
	</select>
	
	<select id="getDeleteFileList" resultType="ProjectNoticeVO" parameterType="ProjectNoticeVO">
		select sfile_nm, file_path, prj_id, bbs_seq, file_seq
		from p_prj_bbs_attach_file
		where prj_id = #{prj_id}
		and bbs_seq = #{bbs_seq}
	</select>
	
	<update id="hitcntUp" parameterType="ProjectNoticeVO">
		update p_prj_bbs_contents
		set hit_cnt = (select hit_cnt+1 from p_prj_bbs_contents where bbs_seq = #{bbs_seq})
		where prj_id = #{prj_id}
		and bbs_seq = #{bbs_seq}
	</update>
	
	<select id="insertPrjNotice" parameterType="ProjectNoticeVO" resultType="ProjectNoticeVO">
		insert into p_prj_bbs_contents(prj_id, contents_type, parent_no, order_no, depth_no, title, contents, hit_cnt, remote_ip, reg_id, reg_date)
		values(#{prj_id}, #{contents_type}, IDENT_CURRENT('p_prj_bbs_contents'),0,0,
		#{title},#{contents},0,#{remote_ip},#{reg_id},#{reg_date})
		SELECT @@IDENTITY AS bbs_seq
	</select>
	
	<update id="updatePrjNotice" parameterType="ProjectNoticeVO">
		update p_prj_bbs_contents
		set title = #{title}, contents = #{contents}, mod_id = #{mod_id}, mod_date = #{mod_date}, contents_type = #{contents_type}
		where bbs_seq = #{bbs_seq}
	</update>
	
	<delete id="deletePrjNotice" parameterType="ProjectNoticeVO">
		delete from p_prj_bbs_contents
		where bbs_seq = #{bbs_seq}
	</delete>
	
	<insert id="fileUploadPrjNotice" parameterType="ProjectNoticeVO">
		insert into p_prj_bbs_attach_file(
			prj_id,
			bbs_seq,
			rfile_nm,
			sfile_nm,
			file_size,
			file_path,
			reg_id,
			reg_date,
			mod_id,
			mod_date		
		)
		values(
			#{prj_id},
			#{bbs_seq},
			#{rfile_nm},
			#{sfile_nm},
			#{file_size},
			#{file_path},
			#{reg_id},
			#{reg_date},
			#{mod_id},
			#{mod_date}
		)
	</insert>
	
	<delete id="deleteFile" parameterType="ProjectNoticeVO">
		delete from p_prj_bbs_attach_file
		where file_seq = #{file_seq}
		and prj_id = #{prj_id}
	</delete>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</mapper>