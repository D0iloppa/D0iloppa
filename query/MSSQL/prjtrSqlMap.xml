<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="prjtrSqlMap">
	<select id="getUsedTRIncoming" resultType="int" parameterType="PrjDocumentIndexVO">
		select count(*) from p_prj_tr_file where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and rtn_status_code_id is not null and rtn_status_code_id!=''
	</select>
	<select id="getUsedVTRIncoming" resultType="int" parameterType="PrjDocumentIndexVO">
		select count(*) from p_prj_vtr_file where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and rtn_status_code_id is not null and rtn_status_code_id!=''
	</select>
	<select id="getUsedSTRIncoming" resultType="int" parameterType="PrjDocumentIndexVO">
		select count(*) from p_prj_str_file where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and rtn_status_code_id is not null and rtn_status_code_id!=''
	</select>
	<select id="getPrjTrHistory" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select set_code from p_prj_code_settings c where c.prj_id=#{prj_id} and c.set_code_type='TR ISSUE PURPOSE' and c.set_code_id=a.tr_issuepur_code_id) as purpose,
			(select doc_no from p_prj_document_index d where d.prj_id=#{prj_id} and d.doc_id=b.doc_id and d.rev_id=b.rev_id) as doc_no,
			(select set_code from p_prj_code_settings e where e.prj_id=#{prj_id} and e.set_code_type='TR RETURN STATUS' and e.set_code_id=b.rtn_status_code_id) as rtn 
		from p_prj_tr_info a join p_prj_tr_file b on a.prj_id=b.prj_id and a.tr_id=b.tr_id
		where a.prj_id=#{prj_id} and b.doc_id=#{doc_id} and a.tr_id in (select tr_id from p_prj_tr_file where prj_id=#{prj_id} and doc_id=#{doc_id})
		order by a.send_date desc
	</select>
	<select id="getPrjVTrHistory" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select set_code from p_prj_code_settings c where c.prj_id=#{prj_id} and c.set_code_type='TR ISSUE PURPOSE' and c.set_code_id=a.tr_issuepur_code_id) as purpose,
			(select doc_no from p_prj_document_index d where d.prj_id=#{prj_id} and d.doc_id=b.doc_id and d.rev_id=b.rev_id) as doc_no,
			(select set_code from p_prj_code_settings e where e.prj_id=#{prj_id} and e.set_code_type='TR RETURN STATUS' and e.set_code_id=b.rtn_status_code_id) as rtn 
		from p_prj_vtr_info a join p_prj_vtr_file b on a.prj_id=b.prj_id and a.tr_id=b.tr_id
		where a.prj_id=#{prj_id} and b.doc_id=#{doc_id} and a.tr_id in (select tr_id from p_prj_vtr_file where prj_id=#{prj_id} and doc_id=#{doc_id})
		order by a.send_date desc
	</select>
	<select id="getPrjSTrHistory" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select set_code from p_prj_code_settings c where c.prj_id=#{prj_id} and c.set_code_type='TR ISSUE PURPOSE' and c.set_code_id=a.tr_issuepur_code_id) as purpose,
			(select doc_no from p_prj_document_index d where d.prj_id=#{prj_id} and d.doc_id=b.doc_id and d.rev_id=b.rev_id) as doc_no,
			(select set_code from p_prj_code_settings e where e.prj_id=#{prj_id} and e.set_code_type='TR RETURN STATUS' and e.set_code_id=b.rtn_status_code_id) as rtn 
		from p_prj_str_info a join p_prj_str_file b on a.prj_id=b.prj_id and a.tr_id=b.tr_id
		where a.prj_id=#{prj_id} and b.doc_id=#{doc_id} and a.tr_id in (select tr_id from p_prj_str_file where prj_id=#{prj_id} and doc_id=#{doc_id})
		order by a.send_date desc
	</select>
	<select id="isDuplicateTrNo" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_tr_info where prj_id=#{prj_id} and tr_no=#{tr_no}
	</select>
	<select id="isDuplicateVTrNo" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_vtr_info where prj_id=#{prj_id} and tr_no=#{tr_no}
	</select>
	<select id="isDuplicateSTrNo" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_str_info where prj_id=#{prj_id} and tr_no=#{tr_no}
	</select>
	<select id="isDuplicateTrNoByUpdate" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_tr_info where prj_id=#{prj_id} and tr_no=#{tr_no} and tr_id!=#{tr_id}
	</select>
	<select id="isDuplicateVTrNoByUpdate" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_vtr_info where prj_id=#{prj_id} and tr_no=#{tr_no} and tr_id!=#{tr_id}
	</select>
	<select id="isDuplicateSTrNoByUpdate" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_str_info where prj_id=#{prj_id} and tr_no=#{tr_no} and tr_id!=#{tr_id}
	</select>
	<insert id="insertTrInfo" parameterType="PrjTrVO">
		insert into p_prj_tr_info(prj_id,tr_id,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id}),CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'N','checking',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_tr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertTrInfoIncoming" parameterType="PrjTrVO">
		insert into p_prj_tr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_tr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertTrInfoIncomingNotAuto" parameterType="PrjTrVO">
		insert into p_prj_tr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_tr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertVTrInfo" parameterType="PrjTrVO">
		insert into p_prj_vtr_info(prj_id,tr_id,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id}),CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'N','checking',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_vtr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertVTrInfoIncoming" parameterType="PrjTrVO">
		insert into p_prj_vtr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_vtr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertVTrInfoIncomingNotAuto" parameterType="PrjTrVO">
		insert into p_prj_vtr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_vtr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertSTrInfo" parameterType="PrjTrVO">
		insert into p_prj_str_info(prj_id,tr_id,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id}),CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'N','checking',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_str_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertSTrInfoIncoming" parameterType="PrjTrVO">
		insert into p_prj_str_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_str_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<insert id="insertSTrInfoIncomingNotAuto" parameterType="PrjTrVO">
		insert into p_prj_str_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,tr_remark,tr_distribute,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id}),#{tr_no},CONCAT('i',#{tr_no}),#{tr_subject},#{discipline_code_id},'IN',#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},'OWNER','HHI',#{tr_remark},#{tr_distribute},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_str_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	<update id="updateTrInfo" parameterType="PrjTrVO">
		update p_prj_tr_info
		set tr_subject=#{tr_subject},
			discipline_code_id=#{discipline_code_id},
			inout=#{inout},
			issued=#{issued},
			tr_status=#{tr_status},
			tr_issuepur_code_id=#{tr_issuepur_code_id},
			send_date=#{send_date},
			req_date=#{req_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_from=#{tr_from},
			tr_to=#{tr_to},
			chk_date=#{chk_date},
			tr_remark=#{tr_remark},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateTrInfoIncoming" parameterType="PrjTrVO">
		update p_prj_tr_info
		set tr_no=#{tr_no},
			tr_subject=#{tr_subject},
			send_date=#{send_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_remark=#{tr_remark},
			tr_distribute=#{tr_distribute},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateTrSendDateByDCC" parameterType="PrjTrVO">
		update p_prj_tr_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTrSendDateByDCC" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTrSendDateByDCC" parameterType="PrjTrVO">
		update p_prj_str_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTrInfo" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set tr_subject=#{tr_subject},
			discipline_code_id=#{discipline_code_id},
			inout=#{inout},
			issued=#{issued},
			tr_status=#{tr_status},
			tr_issuepur_code_id=#{tr_issuepur_code_id},
			send_date=#{send_date},
			req_date=#{req_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_from=#{tr_from},
			tr_to=#{tr_to},
			chk_date=#{chk_date},
			tr_remark=#{tr_remark},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTrInfoIncoming" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set tr_no=#{tr_no},
			tr_subject=#{tr_subject},
			send_date=#{send_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_remark=#{tr_remark},
			tr_distribute=#{tr_distribute},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTrInfo" parameterType="PrjTrVO">
		update p_prj_str_info
		set tr_subject=#{tr_subject},
			discipline_code_id=#{discipline_code_id},
			inout=#{inout},
			issued=#{issued},
			tr_status=#{tr_status},
			tr_issuepur_code_id=#{tr_issuepur_code_id},
			send_date=#{send_date},
			req_date=#{req_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_from=#{tr_from},
			tr_to=#{tr_to},
			chk_date=#{chk_date},
			tr_remark=#{tr_remark},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTrInfoIncoming" parameterType="PrjTrVO">
		update p_prj_str_info
		set tr_no=#{tr_no},
			tr_subject=#{tr_subject},
			send_date=#{send_date},
			tr_writer_id=#{tr_writer_id},
			tr_modifier_id=#{tr_modifier_id},
			tr_remark=#{tr_remark},
			tr_distribute=#{tr_distribute},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
    <select id="isExistTrNo" parameterType="PrjTrVO" resultType="int">
    	select count(*) from ${tr_table} where prj_id=#{prj_id} and tr_no=#{change_tr_no}
    </select>
    <select id="getChangingTrInfo" parameterType="PrjTrVO" resultType="PrjTrVO">
    	select * from ${tr_table} where prj_id=#{prj_id} and tr_no=#{old_tr_no}
    </select>
	<insert id="insertTrNoChgHist" parameterType="PrjDocTrNoChgHistVO">
		insert into p_prj_trno_chg_hist(log_date,prj_id,tr_type,tr_id,old_tr_no,chg_tr_no,i_tr_no,reg_id,remote_ip)
		values(#{log_date},#{prj_id},#{tr_type},#{tr_id},#{old_tr_no},#{chg_tr_no},#{i_tr_no},#{reg_id},#{remote_ip})
	</insert>
    <select id="getTrNoChgHist" parameterType="PrjDocTrNoChgHistVO" resultType="PrjDocTrNoChgHistVO">
    	select * from p_prj_trno_chg_hist 
    	where tr_type=#{tr_type}
		<if test="prj_id != '' ">
    		and prj_id=#{prj_id}
		</if>
		<if test="from != '' ">
			and substring(log_date,1,8) between #{from} and #{to}
		</if>
		order by log_date desc
    </select>
    <update id="changeTrNo" parameterType="PrjTrVO">
    	update ${tr_table}
    	set tr_no=#{change_tr_no}
    	where prj_id=#{prj_id} and tr_no=#{old_tr_no}
    </update>
	<insert id="insertTrFile" parameterType="PrjTrVO">
		insert into p_prj_tr_file(prj_id,tr_id,doc_id,rev_id,rev_no,issue_step,rtn_status_code_id,doc_table,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},#{tr_id},#{doc_id},#{rev_id},#{rev_no},#{tr_issuepur_code_id},#{rtn_status_code_id},#{doc_table},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
	</insert>
	<select id="selectTrFile" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_tr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</select>
	<insert id="insertVTrFile" parameterType="PrjTrVO">
		insert into p_prj_vtr_file(prj_id,tr_id,doc_id,rev_id,rev_no,issue_step,rtn_status_code_id,doc_table,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},#{tr_id},#{doc_id},#{rev_id},#{rev_no},#{tr_issuepur_code_id},#{rtn_status_code_id},#{doc_table},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
	</insert>
	<select id="selectVTrFile" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_vtr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</select>
	<insert id="insertSTrFile" parameterType="PrjTrVO">
		insert into p_prj_str_file(prj_id,tr_id,doc_id,rev_id,rev_no,issue_step,rtn_status_code_id,doc_table,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},#{tr_id},#{doc_id},#{rev_id},#{rev_no},#{tr_issuepur_code_id},#{rtn_status_code_id},#{doc_table},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
	</insert>
	<select id="selectSTrFile" resultType="int" parameterType="PrjTrVO">
		select count(*) from p_prj_str_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</select>
	<delete id="deleteTrFile" parameterType="PrjTrVO">
		delete from p_prj_tr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</delete>
	<delete id="deleteTrInfo" parameterType="PrjTrVO">
		delete from p_prj_tr_info
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<delete id="deleteTrFileAll" parameterType="PrjTrVO">
		delete from p_prj_tr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<delete id="deleteVTrFile" parameterType="PrjTrVO">
		delete from p_prj_vtr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</delete>
	<delete id="deleteVTrInfo" parameterType="PrjTrVO">
		delete from p_prj_vtr_info
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<delete id="deleteVTrFileAll" parameterType="PrjTrVO">
		delete from p_prj_vtr_file
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<delete id="deleteSTrFile" parameterType="PrjTrVO">
		delete from p_prj_str_file
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</delete>
	<delete id="deleteSTrInfo" parameterType="PrjTrVO">
		delete from p_prj_str_info
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<delete id="deleteSTrFileAll" parameterType="PrjTrVO">
		delete from p_prj_str_file
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</delete>
	<select id="getTrInOutSearch" resultType="PrjTrVO" parameterType="PrjTrVO">
		select
			*,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discip,
			(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
			(select user_eng_nm from p_users where user_id=a.mod_id) as mod_nm
		from p_prj_tr_info a
		where prj_id=#{prj_id} and inout=#{inout}
			<if test='tr_status != "all"'>
				and tr_status = #{tr_status}
			</if>
			<if test='tr_period != "all"'>
				and #{tr_from_search} <![CDATA[ <= ]]> a.send_date and a.send_date <![CDATA[ <= ]]> #{tr_to_search}
			</if>
			<if test='tr_no != ""'>
				and tr_no like CONCAT('%',#{tr_no},'%')
			</if>
			<if test='tr_subject != ""'>
				and tr_subject like CONCAT('%',#{tr_subject},'%')
			</if>
		order by a.reg_date desc
    </select>
	<select id="getVTrInOutSearch" resultType="PrjTrVO" parameterType="PrjTrVO">
		select
			*,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discip,
			(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
			(select user_eng_nm from p_users where user_id=a.mod_id) as mod_nm
		from p_prj_vtr_info a
		where prj_id=#{prj_id} and inout=#{inout}
			<if test='tr_status != "all"'>
				and tr_status = #{tr_status}
			</if>
			<if test='tr_period != "all"'>
				and #{tr_from_search} <![CDATA[ <= ]]> a.send_date and a.send_date <![CDATA[ <= ]]> #{tr_to_search}
			</if>
			<if test='tr_no != ""'>
				and tr_no like CONCAT('%',#{tr_no},'%')
			</if>
			<if test='tr_subject != ""'>
				and tr_subject like CONCAT('%',#{tr_subject},'%')
			</if>
		order by a.reg_date desc
    </select>
	<select id="getSTrInOutSearch" resultType="PrjTrVO" parameterType="PrjTrVO">
		select
			*,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discip,
			(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
			(select user_eng_nm from p_users where user_id=a.mod_id) as mod_nm
		from p_prj_str_info a
		where prj_id=#{prj_id} and inout=#{inout}
			<if test='tr_status != "all"'>
				and tr_status = #{tr_status}
			</if>
			<if test='tr_period != "all"'>
				and #{tr_from_search} <![CDATA[ <= ]]> a.send_date and a.send_date <![CDATA[ <= ]]> #{tr_to_search}
			</if>
			<if test='tr_no != ""'>
				and tr_no like CONCAT('%',#{tr_no},'%')
			</if>
			<if test='tr_subject != ""'>
				and tr_subject like CONCAT('%',#{tr_subject},'%')
			</if>
		order by a.reg_date desc
    </select>
	<select id="getTrInfo" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
		(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose, 
		(select set_desc from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose_desc, 
		(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discipline,
		(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
		(select user_eng_nm from p_users where user_id=a.tr_modifier_id) as modifier,
		(select user_kor_nm from p_users where user_id=a.tr_writer_id) as writer_kor,
		(select user_kor_nm from p_users where user_id=a.tr_modifier_id) as modifier_kor,
		(select rfile_nm from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as rfile_nm,
		(select file_type from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as file_type	
		from p_prj_tr_info a
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getTrFile" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select folder_id from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as folder_id,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR RETURN STATUS' and set_code_id=x.rtn_status_code_id) as return_status,	
			(select doc_no from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as doc_no,
			(select set_code from p_prj_document_index a join p_prj_code_settings b on a.prj_id=b.prj_id and a.rev_code_id=b.set_code_id where b.prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id and b.set_code_type='REVISION NUMBER') as rev_no
		from p_prj_tr_file x where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getUseDocInTR" resultType="PrjTrVO" parameterType="PrjTrVO">
		select ISNULL(tr_no,itr_no) as tr_no from p_prj_tr_file a join p_prj_tr_info b on a.prj_id = b.prj_id and a.tr_id = b.tr_id  where a.prj_id=#{prj_id} and a.doc_id=#{doc_id} and a.rev_id=#{rev_id}
	</select>
	<select id="getUseDocInVTR" resultType="PrjTrVO" parameterType="PrjTrVO">
		select ISNULL(tr_no,itr_no) as tr_no from p_prj_vtr_file a join p_prj_vtr_info b on a.prj_id = b.prj_id and a.tr_id = b.tr_id  where a.prj_id=#{prj_id} and a.doc_id=#{doc_id} and a.rev_id=#{rev_id}
	</select>
	<select id="getUseDocInSTR" resultType="PrjTrVO" parameterType="PrjTrVO">
		select ISNULL(tr_no,itr_no) as tr_no from p_prj_str_file a join p_prj_str_info b on a.prj_id = b.prj_id and a.tr_id = b.tr_id  where a.prj_id=#{prj_id} and a.doc_id=#{doc_id} and a.rev_id=#{rev_id}
	</select>
	<select id="getUseDocInDRN" resultType="PrjDrnInfoVO" parameterType="PrjDrnInfoVO">
		select b.drn_no
		from p_prj_drn_attch_file a join p_prj_drn_info b on a.prj_id=b.prj_id and a.drn_id=b.drn_id
		where a.prj_id=#{prj_id} and a.doc_id=#{doc_id} and a.rev_id=#{rev_id} and b.drn_approval_status != 'R'
	</select>
	<select id="getUseDocInDRNisnotRorC" resultType="PrjDrnInfoVO" parameterType="PrjDrnInfoVO">
		select b.drn_no
		from p_prj_drn_attch_file a join p_prj_drn_info b on a.prj_id=b.prj_id and a.drn_id=b.drn_id
		where a.prj_id=#{prj_id} and a.doc_id=#{doc_id} and a.rev_id=#{rev_id} and b.drn_approval_status != 'R' and b.drn_approval_status != 'C'
	</select>
	<select id="getIsUseDRN" resultType="PrjDrnInfoVO" parameterType="PrjTrVO">
		select drn_id,drn_no from p_prj_drn_info where prj_id=#{prj_id} and drn_no=#{tr_subject} and drn_approval_status='C'
	</select>
	<select id="getVTrInfo" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
		(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='VTR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose, 
		(select set_desc from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='VTR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose_desc, 
		(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discipline,
		(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
		(select user_eng_nm from p_users where user_id=a.tr_modifier_id) as modifier,
		(select user_kor_nm from p_users where user_id=a.tr_writer_id) as writer_kor,
		(select user_kor_nm from p_users where user_id=a.tr_modifier_id) as modifier_kor,
		(select rfile_nm from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as rfile_nm,
		(select file_type from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as file_type	
		from p_prj_vtr_info a
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getVTrFile" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select folder_id from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as folder_id,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='VTR RETURN STATUS' and set_code_id=x.rtn_status_code_id) as return_status,	
			(select doc_no from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as doc_no,
			(select set_code from p_prj_document_index a join p_prj_code_settings b on a.prj_id=b.prj_id and a.rev_code_id=b.set_code_id where b.prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id and b.set_code_type='REVISION NUMBER') as rev_no
		from p_prj_vtr_file x where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getSTrInfo" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
		(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='STR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose, 
		(select set_desc from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='STR ISSUE PURPOSE' and set_code_id=a.tr_issuepur_code_id) as issuepurpose_desc, 
		(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=a.discipline_code_id) as discipline,
		(select user_eng_nm from p_users where user_id=a.tr_writer_id) as writer,
		(select user_eng_nm from p_users where user_id=a.tr_modifier_id) as modifier,
		(select user_kor_nm from p_users where user_id=a.tr_writer_id) as writer_kor,
		(select user_kor_nm from p_users where user_id=a.tr_modifier_id) as modifier_kor,
		(select rfile_nm from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as rfile_nm,
		(select file_type from p_prj_document_index where prj_id=#{prj_id} and trans_ref_doc_id='COVER' and doc_no=a.tr_no) as file_type	
		from p_prj_str_info a
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getSTrFile" resultType="PrjTrVO" parameterType="PrjTrVO">
		select *,
			(select folder_id from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as folder_id,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='STR RETURN STATUS' and set_code_id=x.rtn_status_code_id) as return_status,	
			(select doc_no from p_prj_document_index where prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id) as doc_no,
			(select set_code from p_prj_document_index a join p_prj_code_settings b on a.prj_id=b.prj_id and a.rev_code_id=b.set_code_id where b.prj_id=#{prj_id} and doc_id=x.doc_id and rev_id=x.rev_id and b.set_code_type='REVISION NUMBER') as rev_no
		from p_prj_str_file x where prj_id=#{prj_id} and tr_id=#{tr_id}
	</select>
	<select id="getTRSerialNo" resultType="String" parameterType="PrjTrVO">
		SELECT TOP(1) FORMAT(CONVERT(int,sub1.value)+1,'D${serialLength}')
		FROM (
		SELECT ISNUMERIC(value) as isnumeric ,value
		from String_split((select top(1) tr_no
		from p_prj_tr_info ppti
		where prj_id=#{prj_id}
		and ppti.tr_no like #{stringForm} order by ppti.tr_no desc),'-')
		)sub1
		where sub1.isnumeric = 1
		order by ROW_NUMBER() OVER(ORDER BY (SELECT 1)) desc
		<!-- select ISNULL((SELECT TOP 1 (FORMAT(CONVERT(int,replace(ppti.tr_no,#{replaceForm},''))+1,'D${serialLength}')) as serialMax
				from p_prj_tr_info ppti
				where ppti.prj_id=#{prj_id} and ppti.tr_no like #{stringForm}
				ORDER BY serialMax desc),(select replace(set_val,#{replaceForm},'') from p_prj_code_settings where prj_id=#{prj_id} and set_code_type=#{set_code_type} and set_code=#{set_code})
			) AS serial	 -->
	</select>
	<select id="getVTRSerialNo" resultType="String" parameterType="PrjTrVO">
		SELECT TOP(1) FORMAT(CONVERT(int,sub1.value)+1,'D${serialLength}')
		FROM (
		SELECT ISNUMERIC(value) as isnumeric ,value
		from String_split((select top(1) tr_no
		from p_prj_vtr_info ppti
		where prj_id=#{prj_id}
		and ppti.tr_no like #{stringForm} order by ppti.tr_no desc),'-')
		)sub1
		where sub1.isnumeric = 1
		order by ROW_NUMBER() OVER(ORDER BY (SELECT 1)) desc
	</select>
	<select id="getSTRSerialNo" resultType="String" parameterType="PrjTrVO">
		SELECT TOP(1) FORMAT(CONVERT(int,sub1.value)+1,'D${serialLength}')
		FROM (
		SELECT ISNUMERIC(value) as isnumeric ,value
		from String_split((select top(1) tr_no
		from p_prj_str_info ppti
		where prj_id=#{prj_id}
		and ppti.tr_no like #{stringForm} order by ppti.tr_no desc),'-')
		)sub1
		where sub1.isnumeric = 1
		order by ROW_NUMBER() OVER(ORDER BY (SELECT 1)) desc
	</select>
	<update id="updateTRIssueCancel" parameterType="PrjTrVO">
		update p_prj_tr_info
		set issued = 'N',
			tr_status = 'checking',
			tr_no=null,
			chk_date=''
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<delete id="deleteTREmailHistory" parameterType="PrjTrVO">
		delete from p_prj_email_send_info where prj_id=#{prj_id} and user_data00=#{tr_no}
	</delete>
	<update id="updateTRNOandIssued" parameterType="PrjTrVO">
		update p_prj_tr_info
		set tr_no = #{tr_no},
			issued='Y',
			tr_status = #{tr_status},
			chk_date = #{chk_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTRIssueCancel" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set issued = 'N',
			tr_status = 'checking',
			tr_no=null,
			chk_date=''
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTRNOandIssued" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set tr_no = #{tr_no},
			issued='Y',
			tr_status = #{tr_status},
			chk_date = #{chk_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTRIssueCancel" parameterType="PrjTrVO">
		update p_prj_str_info
		set issued = 'N',
			tr_status = 'checking',
			tr_no=null,
			chk_date=''
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTRNOandIssued" parameterType="PrjTrVO">
		update p_prj_str_info
		set tr_no = #{tr_no},
			issued='Y',
			tr_status = #{tr_status},
			chk_date = #{chk_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<select id="isDuplicationDocInIssue" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select b.tr_no as duplicationDoc
			from p_prj_tr_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_tr_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<select id="isDuplicationDocVTRInIssue" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select b.tr_no as duplicationDoc
			from p_prj_vtr_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_vtr_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<select id="isDuplicationDocSTRInIssue" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select b.tr_no as duplicationDoc
			from p_prj_str_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_str_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<select id="isDuplicationDoc" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select ISNULL(b.tr_no,b.itr_no) as duplicationDoc
			from p_prj_tr_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_tr_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<select id="isDuplicationDocVTR" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select ISNULL(b.tr_no,b.itr_no) as duplicationDoc
			from p_prj_vtr_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_vtr_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<select id="isDuplicationDocSTR" resultType="PrjDocumentIndexVO" parameterType="PrjDocumentIndexVO">
		select ISNULL(b.tr_no,b.itr_no) as duplicationDoc
			from p_prj_str_file a,
			(select tr_id, tr_no, itr_no
			from p_prj_str_info
			where prj_id=#{prj_id} and inout='OUT') b
		where prj_id=#{prj_id} and doc_id=#{doc_id} and rev_id=#{rev_id} and a.tr_id=b.tr_id
	</select>
	<update id="updateTrSendDate" parameterType="PrjTrVO">
		update p_prj_tr_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateVTrSendDate" parameterType="PrjTrVO">
		update p_prj_vtr_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<update id="updateSTrSendDate" parameterType="PrjTrVO">
		update p_prj_str_info
		set send_date=#{send_date},
			req_date=#{req_date},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id}
	</update>
	<select id="getIssueCodeByMailSending" resultType="PrjTrVO" parameterType="PrjTrVO">
		select set_code_id
		from p_prj_code_settings c,
		(select (select b.set_code from p_prj_code_settings b where b.prj_id=#{prj_id} and b.set_code_type='TR ISSUE PURPOSE' and b.set_code_id=a.tr_issuepur_code_id) as issue_code
		from p_prj_tr_info a where a.prj_id=#{prj_id} and a.tr_id=#{tr_id}) d
		where c.prj_id=#{prj_id} and c.set_code_type=#{set_code_type} and c.set_val2 like #{concatStr} and c.set_code=d.issue_code
    </select>
	<select id="getIssueCodeByMailSendingVTR" resultType="PrjTrVO" parameterType="PrjTrVO">
		select set_code_id
		from p_prj_code_settings c,
		(select (select b.set_code from p_prj_code_settings b where b.prj_id=#{prj_id} and b.set_code_type='TR ISSUE PURPOSE' and b.set_code_id=a.tr_issuepur_code_id) as issue_code
		from p_prj_vtr_info a where a.prj_id=#{prj_id} and a.tr_id=#{tr_id}) d
		where c.prj_id=#{prj_id} and c.set_code_type=#{set_code_type} and c.set_val2 like #{concatStr} and c.set_code=d.issue_code
    </select>
	<select id="getIssueCodeByMailSendingSTR" resultType="PrjTrVO" parameterType="PrjTrVO">
		select set_code_id
		from p_prj_code_settings c,
		(select (select b.set_code from p_prj_code_settings b where b.prj_id=#{prj_id} and b.set_code_type='TR ISSUE PURPOSE' and b.set_code_id=a.tr_issuepur_code_id) as issue_code
		from p_prj_str_info a where a.prj_id=#{prj_id} and a.tr_id=#{tr_id}) d
		where c.prj_id=#{prj_id} and c.set_code_type=#{set_code_type} and c.set_val2 like #{concatStr} and c.set_code=d.issue_code
    </select>
	<select id="getSearchTRNo" resultType="PrjTrVO" parameterType="PrjTrVO">
    	select distinct *,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='TR ISSUE PURPOSE' and set_code_id=d.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=d.discipline_code_id) as discip
		from p_prj_tr_info d,
			(select a.tr_id from p_prj_tr_file a join p_prj_document_index b on a.prj_id=b.prj_id and a.doc_id=b.doc_id and a.rev_id=b.rev_id where doc_no like CONCAT('%',#{doc_no},'%')) c
		where d.prj_id=#{prj_id} and d.tr_id=c.tr_id and d.inout='OUT'
	</select>
	<select id="getSearchVTRNo" resultType="PrjTrVO" parameterType="PrjTrVO">
    	select distinct *,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='VTR ISSUE PURPOSE' and set_code_id=d.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=d.discipline_code_id) as discip
		from p_prj_vtr_info d,
			(select a.tr_id from p_prj_vtr_file a join p_prj_document_index b on a.prj_id=b.prj_id and a.doc_id=b.doc_id and a.rev_id=b.rev_id where doc_no like CONCAT('%',#{doc_no},'%')) c
		where d.prj_id=#{prj_id} and d.tr_id=c.tr_id and d.inout='OUT'
	</select>
	<select id="getSearchSTRNo" resultType="PrjTrVO" parameterType="PrjTrVO">
    	select distinct *,
			(select set_code from p_prj_code_settings where prj_id=#{prj_id} and set_code_type='STR ISSUE PURPOSE' and set_code_id=d.tr_issuepur_code_id) as issue_pur,
			(select discip_display from p_prj_discipline_info where prj_id=#{prj_id} and discip_code_id=d.discipline_code_id) as discip
		from p_prj_str_info d,
			(select a.tr_id from p_prj_str_file a join p_prj_document_index b on a.prj_id=b.prj_id and a.doc_id=b.doc_id and a.rev_id=b.rev_id where doc_no like CONCAT('%',#{doc_no},'%')) c
		where d.prj_id=#{prj_id} and d.tr_id=c.tr_id and d.inout='OUT'
	</select>
	<update id="updateRtnStatus" parameterType="PrjTrVO">
		update p_prj_tr_file
		set rtn_status_code_id=#{rtn_status_code_id},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</update>
	<update id="updateRtnStatusVTR" parameterType="PrjTrVO">
		update p_prj_vtr_file
		set rtn_status_code_id=#{rtn_status_code_id},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</update>
	<update id="updateRtnStatusSTR" parameterType="PrjTrVO">
		update p_prj_str_file
		set rtn_status_code_id=#{rtn_status_code_id},
			mod_id=#{mod_id},
			mod_date=#{mod_date}
		where prj_id=#{prj_id} and tr_id=#{tr_id} and doc_id=#{doc_id} and rev_id=#{rev_id}
	</update>
	<insert id="insertTrInfoForDRN" parameterType="PrjTrVO">
		insert into p_prj_tr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id}),#{tr_no},CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_tr_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'Y','Issued',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_tr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	
	<insert id="insertVTrInfoForDRN" parameterType="PrjTrVO">
		insert into p_prj_vtr_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id}),#{tr_no},CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_vtr_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'Y','Issued',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_vtr_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	
	<insert id="insertSTrInfoForDRN" parameterType="PrjTrVO">
		insert into p_prj_str_info(prj_id,tr_id,tr_no,itr_no,tr_subject,discipline_code_id,inout,issued,tr_status,tr_issuepur_code_id,send_date,req_date,tr_writer_id,tr_modifier_id,tr_from,tr_to,chk_date,tr_remark,reg_id,reg_date,mod_id,mod_date)
		values(#{prj_id},(select ISNULL(FORMAT(MAX(CONVERT(INT,tr_id))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id}),#{tr_no},CONCAT(#{prj_no},'-IT-',(select ISNULL(FORMAT(MAX(CONVERT(INT,RIGHT(itr_no,5)))+1,'00000'),'00001') from p_prj_str_info where prj_id=#{prj_id} and inout='OUT')),#{tr_subject},#{discipline_code_id},#{inout},'Y','Issued',#{tr_issuepur_code_id},#{send_date},#{req_date},#{tr_writer_id},#{tr_modifier_id},#{tr_from},#{tr_to},#{chk_date},#{tr_remark},#{reg_id},#{reg_date},#{reg_id},#{reg_date})
		<selectKey keyProperty="tr_id" resultType="String">
			select FORMAT(MAX(CONVERT(INT,tr_id)),'00000') from p_prj_str_info where prj_id=#{prj_id}
		</selectKey>
	</insert>
	
	
</mapper>